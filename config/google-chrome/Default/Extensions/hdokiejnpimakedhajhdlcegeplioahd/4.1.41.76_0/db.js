var g_db=null,g_indexeddb=!1;
function opendb(){try{if(getBG().g_db_transaction_tested&&!getBG().g_db_transaction_worked)return null;if(null!=g_db)return g_db;if(window.openDatabase)(g_db=openDatabase("lp","1.0","LastPass Local Database",2E5))||console_log("opendb: Failed to open database!");else if(window.indexedDB){var b=indexedDB.open("lp");b.onerror=function(a){indexedDB.deleteDatabase("lp")};b.onsuccess=function(a){g_indexeddb=!0;g_db=a.target.result};b.onupgradeneeded=function(a){var b=a.target.result.createObjectStore("LastPassData",{keyPath:"usertype"});
b.createIndex("username_hash","username_hash",{unique:!1});b=a.target.result.createObjectStore("LastPassSavedLogins2",{keyPath:"username"});b.createIndex("last_login","last_login",{unique:!1});b=a.target.result.createObjectStore("LastPassPreferences",{keyPath:"userkey"});b.createIndex("username_hash","username_hash",{unique:!1})}}else console_log("opendb: open database is not available!")}catch(a){console_log("opendb: Caught exception while opening database: "+a.message)}return g_db}
function createDataTable(b){b&&!g_indexeddb&&b.transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS LastPassData(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, username_hash varchar(255), type varchar(20), data TEXT, CONSTRAINT usertype UNIQUE (username_hash, type))",[],function(b,a){},function(b,a){console_log("createDataTable"+a)})})}
function createSavedLoginsTable(b){b&&!g_indexeddb&&(b.transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS LastPassSavedLogins(username varchar(255) PRIMARY KEY, password varchar(255), last_login datetime)",[],function(b,a){},function(b,a){console_log("createSavedLoginsTable1"+a);alert("executeSQL access is broken. Safari has a bug with Private Browsing that causes this issue.  Restarting Safari typically fixes it. Error: "+a.message+"\nCode: "+a.code)})}),b.transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS LastPassSavedLogins2(username varchar(255) PRIMARY KEY, password text, last_login datetime, protected tinyint(1))",
[],function(b,a){},function(b,a){console_log("createSavedLoginsTable2"+a)})}),b.transaction(function(b){b.executeSql("SELECT * FROM LastPassSavedLogins order by last_login desc",[],function(b,a){for(var c=0;c<a.rows.length;c++){var d=a.rows.item(c).username;b.executeSql("REPLACE INTO LastPassSavedLogins2 (username, password, last_login) VALUES(?, ?, ?)",[d,a.rows.item(c).password,a.rows.item(c).last_login],function(b,a){},function(b,a){console_log(a)});b.executeSql("DELETE FROM LastPassSavedLogins",
[],function(b,a){},function(b,a){console_log(a)})}},function(b,a){console_log("createSavedLoginsTable6"+a)})}))}
function lpSaveData(b,a){if(!lpdisableoffline||"key"!=a&&"accts"!=a)if(null==g_username||""==g_username)console_log("db.js : lpSaveData : returning B");else if(""!=b||!LPISLOC||"key"!=a&&"accts"!=a){var d=opendb();createDataTable(d);d?(console_log("db.js : lpSaveData : writing data : type="+a),g_indexeddb?d.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:db_prepend(g_username_hash),type:a,data:b,usertype:db_prepend(g_username_hash)+"_"+a}):d.transaction(function(c){c.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, ?, ?)",
[db_prepend(g_username_hash),a,b],function(b,c){console_log("db.js : lpSaveData : success : type="+a)},function(b,a){console_log("db.js : lpSaveData : failed error="+a)})})):console_log("server.js : lpSaveData : returning D")}else console_log("db.js : lpSaveData : returning C");else console_log("db.js : lpSaveData : returning A")}
function createPrefsTable(b){b&&!g_indexeddb&&b.transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS LastPassPreferences (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, username_hash varchar(255), prefname varchar(255), prefvalue varchar(255), CONSTRAINT userkey UNIQUE (username_hash, prefname))",[],function(b,a){},function(b,a){console_log("createPrefsTable: "+a)})})}
function deletesavedpw(){var b=opendb();createSavedLoginsTable(b);b&&(g_indexeddb?b.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(g_username)).onsuccess=function(a){a.target.result&&""!=a.target.result.value.password&&(a.target.result.value.password="",b.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(a.target.result.value),g_master_password_saved=!1)}:b.transaction(function(b){b.executeSql("UPDATE LastPassSavedLogins2 SET password = '' WHERE username = ?",
[g_username],function(b,a){g_master_password_saved=!1},function(b,a){console_log("deletesavedpw:"+a)})}))}function protect_data(b,a,d,c){b.length?a&&!g_is_win?c(b):is_chrome_portable()?c(b):(a="",(""!=b||g_is_mac)&&have_binary_function("protect_data")?call_binary_function("protect_data",b,d,function(a){"string"!=typeof a&&(a="");""==a&&(a=b);c(a)}):(""==a&&(a=b),c(a))):c(b)}
function unprotect_data(b,a,d){"undefined"==typeof b?d(null):b.length?a&&!g_is_win?d(b):is_chrome_portable()?d(b):(a="",""!=b&&have_binary_function("unprotect_data")?call_binary_function("unprotect_data",b,function(a){"string"!=typeof a&&(a="");a==b&&(a="");d(a)}):(a==b&&(a=""),d(a))):d(b)}
function set_default_login_username(b){var a=opendb();createSavedLoginsTable(a);if(a){var d=(new Date).getTime();g_indexeddb?a.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(b)).onsuccess=function(c){c=c.target.result?c.target.result.value:{username:b,password:"",last_login:d,"protected":0};a.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(c)}:a.transaction(function(a){a.executeSql("INSERT OR IGNORE INTO LastPassSavedLogins2 (username, password, last_login) VALUES (?, '', ?)",
[b,d],function(a,c){a.executeSql("UPDATE LastPassSavedLogins2 SET last_login = ? WHERE username = ?",[d,b])},function(a,b){console_log(b)})})}};
