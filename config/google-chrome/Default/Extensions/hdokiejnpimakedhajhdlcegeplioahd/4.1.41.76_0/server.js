var g_iterpw=null,jj="",allowmultifactortrust=!0,hidemultifactordisable=!1;
function lplogincheck2(a,b,c,d){console_log("server.js : lplogincheck fromwebsite="+a+" sessionid="+b);if(!skiplogin()){can_chrome_do_math()||openURL(getchromeurl("mathfail.html"));yubikey_cleardata();googleauth_cleardata();outofband_cleardata();securityquestion_cleardata();sesame_cleardata();grid_cleardata();multifactor_cleardata();loginoffline(!0,"logincheck");var e="canexpire=1&cansetuuid=1&method="+encodeURIComponent(get_method())+"&version="+lpversion,e=e+get_devicetype_param();b&&(e+="&sessionid="+
LP.en(b));c&&(e+="&wxusername="+LP.en(c));d&&(e+="&wxhash="+LP.en(d));isDogfood()&&(e+="&dogfood=1");g_lastpoll=lastlogin=(new Date).getTime();b=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";e+="&sessonly="+en(b);console_log("logincheck getting uuid");getuuid(function(b){console_log("logincheck got uuid");if("object"===typeof b){var c=0,d;for(d in b)e+="&uuid"+c+"="+en(b[d]),++c}else e+="&uuid="+en(b);sesame_setdata("logincheckpostdata",e);lpdbg("login",
"Making login check request");lpMakeRequest(base_url+"login_check.php",e,lpLoginCheckResponse,lpLoginCheckError,a)},g_username_hash)}}function lplogincheck(a,b,c,d){lplogincheck2(a,b,c,d)}
function LP_do_login(a,b,c,d,e,f,h,g){function k(c){getBG().make_lp_key_hash_iterations(c,b,get_key_iterations(a),function(a,b){localStorage_setItem("LPMPU",r);protect_data(b,!0,null,function(a){localStorage_setItem(r+"LPMPH",a)})})}if(!skiplogin())if(h){lppassusernamehash&&!lploggedin&&lpnp_notify("login",{data0:a,data1:b});if(!e){var l=opendb();createSavedLoginsTable(l);if(l&&"undefined"!=typeof c&&null!=c){var n=d?b:"";protect_data(n,!1,a,function(b){if(c&&check_email(a)){var d=b!=n?1:0;d||""==
n||(b=lpenc(b,AES.hex2bin(SHA256(a))),d=2);console_log("server.js : saving login credentials");var e=(new Date).getTime();g_indexeddb?l.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put({username:a,password:b,last_login:e,"protected":d}):l.transaction(function(c){c.executeSql("REPLACE INTO LastPassSavedLogins2 (username, password, last_login, protected) VALUES(?, ?, ?, ?)",[a,b,e,d],function(a,b){},function(a,b){console_log(b)})})}else if(g_indexeddb)l.transaction("LastPassSavedLogins2",
"readwrite").objectStore("LastPassSavedLogins2")["delete"](a);else l.transaction(function(b){b.executeSql("DELETE FROM LastPassSavedLogins2 WHERE username=?",[a],function(a,b){},function(a,b){console_log(b)})})})}"undefined"!=typeof c&&null!=c&&(lpPutGblPref("rememberemail",c?1:0),lpPutGblPref("rememberpassword",d?1:0));"undefined"!=typeof f&&lpPutGblPref("showvault",f?1:0);lpWriteAllPrefs()}yubikey_cleardata();googleauth_cleardata();outofband_cleardata();securityquestion_cleardata();sesame_cleardata();
grid_cleardata();e||multifactor_cleardata();a=fix_username(a);var q=get_key_iterations(a);g_local_key=h?h:make_lp_key_iterations(a,b,q);"string"==typeof b&&b.length&&calculateMasterStrength(a,b);g_local_hash=g?lphash=g:lphash=make_lp_hash_iterations(g_local_key,b,q);g_local_key_hex=AES.bin2hex(g_local_key);g_local_key_hash=SHA256(g_local_key);g_username=lpusername=a;g_username_hash=lpusername_hash=SHA256(g_username);g_retryusername=g_username;var r=SHA256(a);h=localStorage_getItem(r+"LPMPS");null==
h?(h=get_random(1E4,9999999).toString(36)+get_random(1E4,9999999).toString(36),k(h),protect_data(h,!0,null,function(a){localStorage_setItem(r+"LPMPS",a)})):unprotect_data(h,!0,k);lploggedinoffline||loginoffline(!0,"pluginlogin");var p="canexpire=1&cansetuuid=1&xml=2&username="+en(a)+"&method="+encodeURIComponent(get_method())+"&hash="+en(g_local_hash)+"&version="+lpversion,p=p+get_devicetype_param(),p=p+("&encrypted_username="+en(lpenc(g_username,null,!0)));console_log("login getting uuid");getuuid(function(c){console_log("login got uuid");
p+="&uuid="+en(c);p+="&lang="+en(lpGetPref("language",navigator.language));c=get_key_iterations(a);p+="&iterations="+en(c);""!=c&&1<parseInt(c)&&(c=checkNeedsPBKDF2v2(a,b),p+=c,""!=c&&"undefined"!=typeof g_oldpbkdf2&&1==g_oldpbkdf2&&(p+="&fallback=1"));c=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";p+="&sessonly="+en(c);sesame_cleardata();sesame_setdata("postdata",p);sesame_setdata("from","login");yubikey_cleardata();yubikey_setdata("postdata",p);yubikey_setdata("from",
"login");g_iterpw=b;googleauth_cleardata();googleauth_setdata("postdata",p);googleauth_setdata("from","login");outofband_cleardata();outofband_setdata("postdata",p);outofband_setdata("from","login");securityquestion_cleardata();securityquestion_setdata("postdata",p);securityquestion_setdata("from","login");grid_cleardata();grid_setdata("postdata",p);grid_setdata("from","login");e||multifactor_cleardata();multifactor_setdata("postdata",p);multifactor_setdata("from","login");p+="&otp=";p+="&sesameotp=";
p+="&multifactorresponse=";GetOTPHash(p)},g_username_hash)}else make_lp_key_iterations(a,b,get_key_iterations(a),function(h){LP_do_login(a,b,c,d,e,f,h,g)})}
function loginoffline(a,b){console_log("server.js : loginoffline from="+b+" offline_before_online="+a);skiplogin()||(null==g_local_key||null==g_username||null==g_username_hash?"frompipes"!=b&&get_saved_logins(function(c){var d="",e="",f=function(c){if((!LPISLOC||!LPISUPEK)&&0<d.length&&0<c.length){g_username=lpusername=d.toLowerCase().replace(/\s*/g,"");g_username_hash=lpusername_hash=SHA256(d);var e=get_key_iterations(g_username);make_lp_key_iterations(g_username,c,e,function(d){g_local_key=d;g_local_hash=
lphash=make_lp_hash_iterations(g_local_key,c,e);g_local_key_hex=AES.bin2hex(g_local_key);g_local_key_hash=SHA256(g_local_key);loginoffline1(a,b)})}};if(0<c.length){d=c[0].username;e=c[0].password;if(1==c[0]["protected"]){unprotect_data(e,!1,f);return}if(2==c[0]["protected"]){f(lpdec(e,AES.hex2bin(SHA256(d))));return}f(e)}lpdbg("login","Trying to log in offline1: skipping because we dont have the user's key")}):loginoffline1(a,b))}
function read_key_from_file(a){have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lpall.slps"),function(b){"string"!=typeof b?a(""):unprotect_data(b,!0,a)}):a("")}
function read_accts_from_file(a){have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lps.act.sxml"),function(b){"string"!=typeof b?a(""):unprotect_data(b,!0,function(b){b=checkIterationsInDataFile(b);"iterationserror"==b?(lpdbg("login","Key iterations mismatch"),a("")):(b=lpdec(b),a(b))})}):a("")}
function loginoffline1(a,b,c){console_log("server.js : loginoffline1 offline_before_online="+a+" from="+b);if(a){if(!g_loggedinoffline){console_log("server.js : DB:opening database");var d=opendb();console_log("server.js : DB:opened database db="+d);createDataTable(d);if(d){console_log("server.js : DB:created database");var e=function(d,e){console_log("server.js : DB:inside transaction A");if(2!=e.rows.length)console_log("server.js : DB:inside transaction B"),LPISLOC&&(!LPISUPEK||c||""==g_username||
AES.hex2bin(SHA256(g_username+""))==g_local_key?lpshowError("LoginError",!1,!0):(g_pwdeckey=g_local_key,lpWriteKeyFile(),g_local_accts_version=0,LPISUPEK&&(g_prompts.login_site_prompt=!0,g_prompts.edit_site_prompt=!0,g_prompts.edit_sn_prompt=!0,g_prompts.view_pw_prompt=!0,g_prompts.view_ff_prompt=!0,g_prompts.switch_identity_prompt=!0,g_prompts.switch_f_prompt=!0,g_prompts.multifactor_reprompt=!0),rewritelocalfile(),loginoffline1(a,b,!0))),console_log("server.js : DB:inside transaction C"),lpdbg("login",
"Trying to log in offline : offline before online failed : could not read keyfile or accts");else{console_log("server.js : DB:inside transaction D");var f="key"==e.rows.item(0).type?0:1,g=e.rows.item(f).data,f=!1,g=g.split("\n");2==g.length&&"lastpass rocks"==lpdec(g[1],g_local_key)&&(console_log("server.js : DB:inside transaction E"),f=!0);f?(console_log("server.js : DB:inside transaction G"),f="accts"==e.rows.item(0).type?0:1,g=e.rows.item(f).data,g=g.substring(0,220),g=checkIterationsInDataFile(g),
"iterationserror"==g?lpdbg("login","Key iterations mismatch, bailing on loginoffline"):0<=g.indexOf("type=sesameoffline\ndata=")||0<=g.indexOf("type=yubikeyoffline\ndata=")||0<=g.indexOf("type=trueapioffline\ndata=")||0<=g.indexOf("type=omnikeyoffline\ndata=")?(console_log("server.js : DB:inside transaction H"),lpdbg("login","Data is encoded with multifactor key, bailing on loginoffline")):(console_log("server.js : DB:inside transaction I"),offlineloginsuccessful(b,!0),lpdbg("login","Trying to log in offline : offline before online successful"))):
(console_log("server.js : DB:inside transaction F"),LPISLOC&&lpshowError("LoginError",!1,!0),lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key"))}},f=function(a,b){lpdbg("login","Trying to log in offline3: skipping because we dont have the user's key")};if(LPISLOC)read_key_from_file(function(a){read_accts_from_file(function(b){""!=a||""!=b?e(tx,{rows:{length:2,item:function(c){return 0==c?{type:"key",data:a}:{type:"accts",data:b}}}}):e(tx,{rows:{length:0}})})});
else if(g_indexeddb){var h={rows:{item:function(a){return this[a]},length:0}};d.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(a){if(a=a.target.result){if("key"==a.value.type||"accts"==a.value.type)h.rows[h.rows.length]=a.value,h.rows.length++;a["continue"]()}else e(null,h)}}else d.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",
[db_prepend(g_username_hash),"key","accts"],e,f)})}else console_log("server.js : DB:failed to create database db="+d)}}else g_loggedinoffline||(d=opendb(),createDataTable(d),d&&(e=function(a,c){if(2!=c.rows.length)lpdbg("login","Trying to log in offline : offline before online failed : could not read keyfile or accts");else{var d="key"==c.rows.item(0).type?0:1,e=c.rows.item(d).data,d=!1,e=e.split("\n");2==e.length&&"lastpass rocks"==lpdec(e[1],g_local_key)&&(d=!0);d?(d="accts"==c.rows.item(0).type?
0:1,e=c.rows.item(d).data,e=e.substring(0,220),e=checkIterationsInDataFile(e),"iterationserror"==e?lpdbg("login","Trying to log in offline: skipping because we have a key iterations mismatch"):0<=e.indexOf("type=sesameoffline\ndata=")?(lpdbg("sesame","Logging in offline and existing file is protected by sesameoffline => asking user for offline password"),sesame_setdata("offline",1),sesame_getotp(null)):0<=e.indexOf("type=trueapioffline\ndata=")||0<=e.indexOf("type=omnikeyoffline\ndata=")?(lpdbg("multifactor",
"Logging in offline and existing file is protected by trueapioffline => asking user for offline password"),d=0<=e.indexOf("type=trueapioffline\ndata=")?"trueapi":"omnikey",multifactor_setdata("offline",1),multifactor_setdata("type",d),multifactor_getresponse(g_username)):0<=e.indexOf("type=yubikeyoffline\ndata=")?(yubikey_setdata("offline",1),yubikey_getotp(null)):(offlineloginsuccessful(b,!1),lpdbg("login","Trying to log in offline : offline after online successful"))):lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key")}},
LPISLOC?read_key_from_file(function(a){read_accts_from_file(function(b){""!=a||""!=b?e(tx,{rows:{length:2,item:function(c){return 0==c?{type:"key",data:a}:{type:"accts",data:b}}}}):e(tx,{rows:{length:0}})})}):g_indexeddb?(h={rows:{item:function(a){return this[a]},length:0}},d.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(a){if(a=a.target.result){if("key"==a.value.type||"accts"==
a.value.type)h.rows[h.rows.length]=a.value,h.rows.length++;a["continue"]()}else e(null,h)}):d.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",[db_prepend(g_username_hash),"key","accts"],e)})))}
function offlineloginsuccessful(a,b){console_log("server.js : offlineloginsuccessful beforeonlineattempt="+b+" from="+a);LPISLOC&&"pluginlogin"==a&&g_manual_login&&(1==lpGetPref("showvault",g_showvaultdefault)||g_showvaultalways)&&(console_log("server.js : offlineloginsuccessful openvault offline version!"),openvault(1));console_log("server.js : offlineloginsuccessful!");g_loggedinonline||(g_loggedinoffline=!0);lploggedin=!0;lpReadAllPrefs(function(){drawIconAtRotation(0)});loggedIn("pluginlogin"==
a);console_log("RSA : offlineloginsuccessful : calling readrsaprivatekeyhexfromdb()");readrsaprivatekeyhexfromdb();"offline"!=a&&(console_log("server.js : offlineloginsuccessful : from "+a+" so calling get_accts_local!"),get_accts_local(!0));g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null);g_notifytimerid=setTimeout(function(){notifyoffline(a)},b?3E4:0);g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null);g_retryonlinetimerid=setTimeout(function(){retryonlinelogin(3E4)},
3E4)}function notifyoffline(a){console_log("server.js : notifyoffline from="+a);lploggedin&&g_loggedinoffline&&(lpdbg("login","Trying to log in offline : notify user that they are logged in offline"),LPISLOC||lpshowError("LoggedInOffline",!1,!1,!1,null,!0))}
function retryonlinelogin(a){console_log("server.js : retryonlinelogin delayms="+a);if(lploggedin&&g_loggedinoffline){lpdbg("login","We're still logged in offline => retrying to login online.  retryinterval="+a/6E4+" minutes");lplogincheck("retryonline");var b=2*a;12E5<b&&(b=12E5);setTimeout(function(){retryonlinelogin(b)},b)}}function lpTurnOffIcon(){lploggedin=!1;set_badge_text("");drawIconAtRotation(0)}
function lpLoginCheckResponse(a,b,c){console_log("server.js : lpLoginCheckResponse fromwebsite="+c);try{if(!a||4!=a.readyState||"function"!=typeof b||200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){if(4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){var d=a.responseXML.documentElement.getElementsByTagName("ok");if(0<d.length){var e=d[0].getAttribute("lpusername");g_username=lpusername=e;g_username_hash=SHA256(g_username);if("retryonline"!=
c&&1!=c){lpReadAllPrefs(function(){lpLoginCheckResponseStep2(a,e,c);drawIconAtRotation(0)});return}}}lpLoginResponse_win(a,c,!0)}else b()}catch(f){L("logincheckresponse: "+f)}}
function lpLoginCheckResponseStep2(a,b,c){console_log("server.js : lpLoginCheckResponseStep2 fromwebsite="+c);try{var d=a.responseXML.documentElement.getElementsByTagName("ok");1==d[0].getAttribute("trustexpired")&&clearuuid(b);var e=d[0].hasAttribute("trustuuid")?d[0].getAttribute("trustuuid"):"";e&&""!=e&&setuuid(e,g_username_hash);lpdbg("login","lpLoginCheckResponseStep2");var f=null!=d[0].getAttribute("sesamepassword")&&""!=d[0].getAttribute("sesamepassword")?!0:!1,h=null!=d[0].getAttribute("yubikeyhash")&&
""!=d[0].getAttribute("yubikeyhash")?!0:!1,g=null!=d[0].getAttribute("googleauthenabled")&&"1"==d[0].getAttribute("googleauthenabled")?!0:!1,k=null!=d[0].getAttribute("gridenabled")&&""!=d[0].getAttribute("gridenabled")?!0:!1,l=null!=d[0].getAttribute("multifactorenabled")&&""!=d[0].getAttribute("multifactorenabled")?!0:!1,n=null!=d[0].getAttribute("sesameotpok")&&""!=d[0].getAttribute("sesameotpok")?!0:!1,q=null!=d[0].getAttribute("yubikeyotpok")&&""!=d[0].getAttribute("yubikeyotpok")?!0:!1,r=null!=
d[0].getAttribute("googleauthotpok")&&""!=d[0].getAttribute("googleauthotpok")?!0:!1,p=null!=d[0].getAttribute("gridresponseok")&&""!=d[0].getAttribute("gridresponseok")?!0:!1,x=null!=d[0].getAttribute("multifactorresponseok")&&""!=d[0].getAttribute("multifactorresponseok")?!0:!1,A=null!=d[0].getAttribute("disableoffline")&&1==d[0].getAttribute("disableoffline")?!0:!1;d[0].getAttribute("model")&&(g_lp_model=d[0].getAttribute("model"));d[0].getAttribute("do_totp")&&(g_do_totp="1"==d[0].getAttribute("do_totp"));
console_log("server.js : ***** disableoffline="+A);if("websitelogin"!=c&&"webrootwebsitelogin"!=c&&"websiterefresh"!=c&&"websiterefreshrsa"!=c&&"2ndfactorok"!=c&&"frompipes"!=c&&(null==g_local_key||""==g_local_key)&&1==lpGetPref("logoffWhenCloseBrowser",0)){var v=lpGetPref("lastpollcheck",0),t=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),u=1E3*lp_get_gmt_timestamp()-v;console_log("server.js : "+v+" "+t+" "+u);if(u>=6E4*t){loggedOut(!1,"logoffWhenCloseBrowser lastpollcheck="+v+
" logoffWhenCloseBrowserVal="+t+" timesincelastpollcheck="+u);1==lpGetPref("openloginstart",LPISUPEK?1:0)&&(g_reprompt_error_callback=g_reprompt_callback=null,open_login());return}}if("httptest"==c){if(f)if(n)c="2ndfactorok",lpdbg("login","LoginCheck : sesame reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for sesame OTP and reissuing request to login_check.php");lpdbg("sesame","LOGIN CHECK RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login_check request");
sesame_setdata("fromwebsite",c);lpCheckForKey(function(){sesame_getotp(b,d[0])});return}if(h)if(q)c="2ndfactorok",lpdbg("login","LoginCheck : yubikey reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for yubikey OTP and reissuing request to login_check.php");lpdbg("yubikey","LOGIN CHECK RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login_check request");yubikey_setdata("fromwebsite",c);lpCheckForKey(function(){yubikey_getotp(b,d[0])});return}if(g)if(r)c=
"2ndfactorok",lpdbg("login","LoginCheck : googleauth reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for googleauth OTP and reissuing request to login_check.php");lpdbg("googleauth","LOGIN CHECK RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login_check request");googleauth_setdata("fromwebsite",c);lpCheckForKey(function(){googleauth_getotp(b,d[0])});return}if(k)if(p)c="2ndfactorok",lpdbg("login","LoginCheck : grid reprompt-rerequest succeeded!");
else{lpdbg("login","LoginCheck : Asking for grid response and reissuing request to login_check.php");lpdbg("grid","LOGIN CHECK RESPONSE: gridenabled => Asking user for coordinates and then reissuing the login_check request");grid_setdata("fromwebsite",c);grid_setdata("wxsessid",d[0].getAttribute("wxsessid"));grid_getvalues(b,d[0].getAttribute("challenge"),d[0]);return}if(l)if(x)c="2ndfactorok",lpdbg("login","LoginCheck : multifactor reprompt-rerequest succeeded!"),"omnikey"==multifactor_getdata("type")&&
multifactor_setdata("password_offline",d[0].getAttribute("multifactorofflinepassword"));else{lpdbg("login","LoginCheck : Asking for multifactor response and reissuing request to login_check.php");lpdbg("multifactor","LOGIN CHECK RESPONSE: multifactorenabled => Asking user for coordinates and then reissuing the login_check request");multifactor_setdata("fromwebsite",c);multifactor_setdata("wxsessid",d[0].getAttribute("wxsessid"));multifactor_setdata("type",d[0].getAttribute("type"));multifactor_getresponse(b,
d[0].getAttribute("challenge"));return}}lpLoginResponse_win(a,c,!0)}catch(z){console_log(z.message)}}function lpLoginResponse2(a,b,c){console_log("server.js : lpLoginResponse fromwebsite="+c);try{console_log("server.js : Got login response"),!a||4!=a.readyState||"function"!=typeof b||200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement?(console_log("server.js : Processing login response"),lpLoginResponse_win(a,c,!1)):b()}catch(d){L("loginresponse: "+d)}}
function lpLoginResponse(a,b,c){lpLoginResponse2(a,b,c)}
function lp_login_from_saved(){console_log("server.js : lp_login_from_saved");try{get_saved_logins(function(a){if(0<a.length){var b=a[0].username,c=a[0].password;if(""!=c){var d=function(a){LPISLOC&&LPISUPEK||""==a||(console_log("server.js : Logging in from saved"),LP_do_login(b,a,!0,!0))};1==a[0]["protected"]?unprotect_data(c,!1,d):2==a[0]["protected"]&&d(lpdec(c,AES.hex2bin(SHA256(a[0].username))));return}}1==lpGetPref("openloginstart",LPISUPEK?1:0)&&(g_reprompt_error_callback=g_reprompt_callback=
null,open_login())})}catch(a){console_log(a.message)}}function lpLoginCommon(a){console_log("server.js : lpLoginCommon bIsLoginCheck="+a);g_loggedinonline=!0;g_loggedinoffline=!1;g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null);g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null)}var lploginerrorhandlercalled=0;
function lpLoginError(){console_log("server.js : lpLoginError");console_log("server.js : Got Login Error");var a=(new Date).getTime();1E3>a-lploginerrorhandlercalled||(lploginerrorhandlercalled=a,lpdbg("login","Login via login.php failed => try logging in offline using saved credentials -- if not already logged in offline --"),loginoffline(!1,"ErrorHandler"))}
function lpLoginCheckError(){console_log("server.js : lpLoginCheckError");lpdbg("login","Got lpLoginCheckError");g_loggedinoffline||(lpshowError("ErrorLoginMsg"),loggedOut(!1,"lpLoginCheckError"),lp_login_from_saved())}
function lpLoginResponse_win(a,b,c){console_log("server.js : lpLoginResponse_win fromwebsite="+b+" bIsLoginCheck="+c);if(a)if(4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){var d=a.responseXML.documentElement,e=d.getElementsByTagName("ok"),f=!1;lpdbg("login","lpLoginResponse_win");if(0<e.length){lpdbg("login","got login ok");(d=e[0].hasAttribute("trustuuid")?e[0].getAttribute("trustuuid"):"")&&""!=d&&setuuid(d,g_username_hash);server_tries=0;g_username=e[0].getAttribute("lpusername");
g_username_hash=SHA256(g_username);d=!1;if(g_is_recovery_login)g_is_recovery_login=!1;else{if("1"==e[0].getAttribute("pwresetreqd")){d=g_username;c?openurlifnotopen(base_url+"passwordreset.php?u="+en(d)):openURL(base_url+"passwordreset.php?u="+en(d));loggedOut(!1,"pwresetreqd set");return}"0"!=e[0].getAttribute("pwresetreqd")&&""!=e[0].getAttribute("pwresetreqd")&&(d=g_username,f="&req="+en(e[0].getAttribute("pwresetreqd")),c?openurlifnotopen(base_url+"passwordreset.php?u="+en(d)+f):openURL(base_url+
"passwordreset.php?u="+en(d)+f),d=!0)}if(e[0].getAttribute("iterations")){f=parseInt(e[0].getAttribute("iterations"));if(!checkIterationsReductionOk(f))return;localStorage_setItem(g_username_hash+"_key_iter",f)}g_iterpw="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";g_pwdeckey=AES.hex2bin(SHA256(e[0].getAttribute("pwdeckey")));g_uid=lpuid=e[0].getAttribute("uid");localStorage_setItem(g_username_hash+"LPMPD",g_uid);g_logoff_other_ses="1"==e[0].getAttribute("logoff_other_ses")?
!0:!1;g_generatedpw="1"==e[0].getAttribute("generatedpw")?!0:!1;countryfromip=e[0].getAttribute("country");g_lastpollcheck=g_lastpoll=lastlogin=(new Date).getTime();g_token=lptoken=e[0].getAttribute("token");var f=e[0].getAttribute("noshare"),h=e[0].getAttribute("noshareexceptfolders");g_sharing_enabled="1"!=f&&"1"!=h;g_folder_sharing_enabled="1"!=f;g_one_minute_inbox_importer_dialog_enabled="1"===e[0].getAttribute("one_minute_inbox_importer_dialog");g_one_minute_signup_enabled="1"===e[0].getAttribute("one_minute_signup");
g_one_minute_signup_menu_enabled="1"===e[0].getAttribute("one_minute_signup_menu");g_onemin_advert_enabled="1"===e[0].getAttribute("one_minute_advert");g_new_settings_enabled="1"===e[0].getAttribute("newsettings_enabled");g_launch_site_tracking_enabled="1"===e[0].getAttribute("launch_site_tracking_enabled");g_onemin_advert_enabled&&sendLpImprove("oneminute::notificationactivated");f=e[0].getAttribute("onemin_advert_app_threshold");null!=f&&(f=parseInt(f),isNaN(f)||(g_onemin_advert_app_threshold=f));
g_nofolder_feature_enabled="1"===e[0].getAttribute("nofolder_feature");g_first_time_login="1"===e[0].getAttribute("first_time_login");LPContentScriptFeatures.new_save_site="1"===e[0].getAttribute("new_save_site");LPContentScriptFeatures.is_infield_enabled="1"===e[0].getAttribute("infield_enabled");LPContentScriptFeatures.is_infield_autopopup_enabled="1"===e[0].getAttribute("infield_autopopup_enabled");LPContentScriptFeatures.is_mobile_active="1"===e[0].getAttribute("mobile_active");g_cid=e[0].getAttribute("cid");
f=e[0].getAttribute("tutorial_enabled");g_ischrome&&f&&("1"===f||"40"===f?LPContentScriptFeatures.tutorial_enabled="40":"41"===f&&(LPContentScriptFeatures.tutorial_enabled="41"));localStorage_setItem("lpfeatures",JSON.stringify(LPFeatures));if(f=e[0].getAttribute("prefdata")){f=atob(f);h={};parsemobile(f,f.length,100,0,null,[],null,null,null,null,null,null,!0,!1,null,null,null,null,null,null,h,null,null,null,null,null,null,null,null,null,null,!1);for(var g in h)if(void 0===g_prefoverrides||g_prefoverrides[g]!==
h[g]){g_prefoverrides=h;rewritelocalfile();break}}(g=e[0].getAttribute("pollinterval"))&&-1!=g&&!isNaN(parseInt(g))&&isFinite(g)&&(lpPutUserPref("pollServerVal",g),lpWriteAllPrefs(),g_flags.pollIntervalSetByPolicy=1);getsinglefactortype(function(a){"1"==e[0].getAttribute("multifactor_singlefactor")?(""==a&&("trueapi"==multifactor_getdata("type")?have_binary_function("trueapi_default_login_exists")&&call_binary_function("trueapi_default_login_exists",g_username,function(a){a&&setsinglefactortype(multifactor_getdata("type"))}):
"vtapi"==e[0].getAttribute("singlefactortype")?have_binary_function("lpvt_has_data")&&call_binary_function("lpvt_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):"validity"==e[0].getAttribute("singlefactortype")?have_binary_function("validity_has_data")&&call_binary_function("validity_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):"winbio"==e[0].getAttribute("singlefactortype")?have_binary_function("winbio_has_data")&&call_binary_function("winbio_has_data",
function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):"nymi"==e[0].getAttribute("singlefactortype")&&have_binary_function("nymi_has_data")&&call_binary_function("nymi_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))})),"nymi"==e[0].getAttribute("singlefactortype")&&have_binary_function("nymi_get_version")&&call_binary_function("nymi_get_version",function(a){parseInt(e[0].getAttribute("nymi_version"))>a&&lpMakeRequest(base_url+"nymi_data.php",
"token="+en(e[0].getAttribute("token"))+"&action=read&b64=1",function(a){4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length&&(call_binary_function("nymi_write_data",lpatob(a[0].getAttribute("data"))),setsinglefactortype("nymi")))})})):""!=a&&disable_single_factor()});sesame_setdata("password_offline",e[0].getAttribute("sesamepassword"));yubikey_setdata("password_offline",e[0].getAttribute("yubikeyhash"));
(g=e[0].getAttribute("note_title"))&&g.length&&(f=e[0].getAttribute("note_text"),h=e[0].hasAttribute("note_url")?e[0].getAttribute("note_url"):null,handlenotifications(g,f,h));lpLoginResponse_win1_5(a,b,c);lpLoginCommon(c);if(lpdisableoffline=1==e[0].getAttribute("disableoffline")?1:0)lpdbg("disableoffline","server.js : enabled => clearing sensitive files"),clearCache(!0,!1,!1,!0);e[0].getAttribute("model")&&(g_lp_model=e[0].getAttribute("model"));e[0].getAttribute("do_totp")&&(g_do_totp="1"==e[0].getAttribute("do_totp"));
!g_manual_login||d||1!=lpGetPref("showvault",g_showvaultdefault)&&!g_showvaultalways||(console_log("openvault from login okay"),"context"!==LPContentScriptFeatures.intro_tutorial_version&&openvault(1));g_manual_login&&!d&&Topics.get(Topics.LOGIN_FINISHED).publish();setTimeout(function(){checkAttach()},1E4)}else{console_log(a.responseText);c=d.getElementsByTagName("error");if(0<c.length){lpdbg("login","got login error");1==c[0].getAttribute("trustexpired")&&clearuuid(g_username);if(c[0].getAttribute("iterations")){f=
parseInt(c[0].getAttribute("iterations"));checkIterationsReductionOk(f)&&(localStorage_setItem(SHA256(g_username)+"_key_iter",f)||(DEFAULT_KEY_ITERATIONS=f),LP_do_login(g_username,g_iterpw));return}if(c[0].getAttribute("pbkdf2fallback")&&("undefined"==typeof g_oldpbkdf2||1!=g_oldpbkdf2)){g_oldpbkdf2=1;yubikey_getdata("p");LP_do_login(g_username,g_iterpw);return}"undefined"!=typeof g_oldpbkdf2&&(g_oldpbkdf2=0);if(c[0].getAttribute("server")){a=c[0].getAttribute("server");if("lastpass.com"==a||"lastpass.eu"==
a)base_url="https://"+a+"/",lpPutGblPref("server",a),LP_do_login(g_username,g_iterpw);return}c[0].getAttribute("openurl")&&(g=c[0].getAttribute("openurl"),openURL(g));if(c[0].hasAttribute("invalidsession")){openURL(base_url+"invalidsession.php");lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"invalidsession");return}f=1==parseInt(c[0].getAttribute("silent"));allowmultifactortrust=!0;0<a.responseText.indexOf("allowmultifactortrust=")&&
(allowtrust_str=a.responseXML.childNodes[0].childNodes[0].getAttribute("allowmultifactortrust"),allowmultifactortrust="false"==allowtrust_str?!1:!0);hidemultifactordisable=!1;0<a.responseText.indexOf("hidedisable=")&&(hidedisable_str=a.responseXML.childNodes[0].childNodes[0].getAttribute("hidedisable"),hidemultifactordisable="false"==hidedisable_str?!1:!0);if(0<a.responseText.indexOf("sesameotprequired")){lpdbg("sesame","LOGIN RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login request");
clearCache(!0,!1,!1);sesame_setdata("fromwebsite",b);sesame_getotp(g_username,c[0]);return}if(0<a.responseText.indexOf("sesameotpfailed")){lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"sesameotpfailed");return}if(0<a.responseText.indexOf("otprequired")){lpdbg("yubikey","LOGIN RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);yubikey_setdata("fromwebsite",
b);yubikey_getotp(g_username,c[0]);return}if(0<a.responseText.indexOf("otpfailed")){lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"otpfailed");return}g=!1;if(0<a.responseText.indexOf("googleauthfailed"))if(g=googleauth_getdata("fail_count"),null==g&&(g=0),g++,googleauth_setdata("fail_count",g),5>g)g=!0;else{googleauth_setdata("fail_count",0);lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):
"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"otpfailed");return}h=!1;if(0<a.responseText.indexOf("securityquestionfailed"))if(h=securityquestion_getdata("fail_count"),null==h&&(h=0),h++,securityquestion_setdata("fail_count",h),5>h)0<c.length&&c[0].getAttribute("message")&&alert(c[0].getAttribute("message")),h=!0;else{securityquestion_setdata("fail_count",0);lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,
"otpfailed");return}if(0<a.responseText.indexOf("googleauthrequired")||g){lpdbg("googleauth","LOGIN RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);googleauth_setdata("fromwebsite",b);googleauth_getotp(g_username,c[0]);return}if(0<a.responseText.indexOf("outofbandrequired")){lpdbg("outofband","LOGIN RESPONSE: outofbandenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);outofband_setdata("fromwebsite",
b);outofband_getotp(g_username,c[0]);return}if(0<a.responseText.indexOf("securityquestionrequired")||h){lpdbg("securityquestion","LOGIN RESPONSE: securityquestionenabled => Asking user for answer and then reissuing the login request");clearCache(!0,!1,!1);securityquestion_setdata("fromwebsite",b);securityquestion_getotp(g_username,c[0]);return}if(0<a.responseText.indexOf("gridresponserequired")){lpdbg("grid","LOGIN RESPONSE: gridenabled => Asking user for grid response and then reissuing the login request");
clearCache(!0,!1,!1);grid_setdata("fromwebsite",b);grid_setdata("wxsessid",c[0].getAttribute("wxsessid"));grid_getvalues(g_username,c[0].getAttribute("challenge"),c[0]);return}if(0<a.responseText.indexOf("gridresponsefailed")){lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"gridresponsefailed");return}if(0<a.responseText.indexOf("multifactorresponserequired")){lpdbg("multifactor","LOGIN RESPONSE: multifactorenabled => Asking user for multifactor response and then reissuing the login request");
clearCache(!0,!1,!1);multifactor_setdata("fromwebsite",b);multifactor_setdata("wxsessid",c[0].getAttribute("wxsessid"));multifactor_setdata("type",c[0].getAttribute("type"));multifactor_getresponse(g_username,c[0].getAttribute("challenge"));return}if(0<a.responseText.indexOf("multifactorresponsefailed")){a=(c=d.getElementsByTagName("error"))&&0<c.length&&c[0].getAttribute("type")?c[0].getAttribute("type"):multifactor_getdata("type");lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):
"LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,a));clearCache(!0,!1,!1);loggedOut(!1,"multifactorresponsefailed");return}}g_trial_available=1==c[0].getAttribute("trialavailable");1==c[0].getAttribute("trialavailable")?lpTurnOffIcon():loggedOut(f,"lpLoginResponse_win A");f?lp_login_from_saved():0<a.responseText.indexOf("blacklist")?(clearCache(!0,!1,!1),lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"Blacklist",!1,!0,!1,null,!1,c[0].getAttribute("custombutton"),
c[0].getAttribute("customaction"))):(a=0<c.length&&c[0].getAttribute("cause")&&"unknownemail"==c[0].getAttribute("cause"),try_alternativeServer()?LP_do_login(g_retryusername,g_iterpw):lpshowError(0<c.length&&c[0].getAttribute("message")?c[0].getAttribute("message"):"LoginError",!1,!0,a,null,!1,c[0].getAttribute("custombutton"),c[0].getAttribute("customaction"),1==c[0].getAttribute("trialavailable")?!0:!1))}}else loggedOut(!1,"lpLoginResponse_win B"),lpshowError("ErrorLoginMsg")}var server_tries=0;
function try_alternativeServer(){if("undefined"!=typeof g_disable_alternative_server&&g_disable_alternative_server||"https://lastpass.com/"==original_base||"https://lastpass.eu/"==original_base)return!1;server_tries++;base_url=3==server_tries||"https://lastpass.com/"==base_url||"https://lastpass.eu/"==base_url?original_base:"https://lastpass.com/";lpPutGblPref("server",base_url.substr(8,base_url.length-1));return 3==server_tries?(server_tries=0,!1):!0}
function disable_single_factor(){getsinglefactortype(function(a){"trueapi"==a&&have_binary_function("trueapi_delete_default_login")&&call_binary_function("trueapi_delete_default_login");setsinglefactortype("")})}
function lpLoginResponse_win1_5(a,b,c){console_log("server.js : lpLoginResponse_win1_5 fromwebsite="+b+" bIsLoginCheck="+c);a.responseXML.documentElement.getElementsByTagName("ok");null==g_local_key||""==g_local_key?"websitelogin"!=b&&"webrootwebsitelogin"!=b&&"websiterefresh"!=b&&"websiterefreshrsa"!=b&&"2ndfactorok"!=b&&"frompipes"!=b&&1==lpGetPref("logoffWhenCloseBrowser",0)?lpReadAllPrefs(function(){lpLoginResponse_win1_75(a,b,c);drawIconAtRotation(0)}):lpReadKeyFile(a,b,!1,c):(lpWriteKeyFile(),
lpReadAllPrefs(function(){lpLoginResponse_win2(a,b,c);drawIconAtRotation(0)}))}function lpLoginResponse_win1_75(a,b,c){console_log("server.js : lpLoginResponse_win1_75 fromwebsite="+b+" bIsLoginCheck="+c);var d=lpGetPref("lastpollcheck",0),e=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),f=1E3*lp_get_gmt_timestamp()-d;f>=6E4*e?loggedOut(!1,"lpLoginResponse_win1_75 lastpollcheck="+d+" logoffWhenCloseBrowserVal="+e+" timesincelastpollcheck="+f):lpReadKeyFile(a,b,!1,c)}
function lpLoginResponse_win2(a,b,c){console_log("server.js : lpLoginResponse_win2 fromwebsite="+b+" bIsLoginCheck="+c);var d=a.responseXML.documentElement,d=d.getElementsByTagName("ok");closeallnotifications(!0,!0);lp_phpsessid=d[0].getAttribute("sessionid");loggedIn();g_server_accts_version=parseInt(d[0].getAttribute("accts_version"));lp_server_attach_version=parseInt(d[0].getAttribute("attachversion"));console_log("server.js : lpLoginResponse_win2 lp_server_attach_version="+lp_server_attach_version);
g_server_accts_version!=g_local_accts_version&&(g_local_accts_version=-1);g_loglogins=parseInt(d[0].getAttribute("loglogins"));g_isadmin=1==parseInt(d[0].getAttribute("isadmin"));g_iscompanyadmin=1==parseInt(d[0].getAttribute("companyadmin"));g_showcredmon=1==parseInt(d[0].getAttribute("showcredmon"));iconsversion=parseInt(d[0].getAttribute("iconsversion"));g_multifactorscore=parseInt(d[0].getAttribute("multifactorscore"));g_disablepwalerts=1==parseInt(d[0].getAttribute("disablepwalerts"));lpsendchallengescore=
null!=d[0].getAttribute("sendchallengescore")&&1==d[0].getAttribute("sendchallengescore")?!0:!1;pwndlistscan=null!=d[0].getAttribute("pwndlistscan")&&1==d[0].getAttribute("pwndlistscan")?!0:!1;loglogin_url=null!=d[0].getAttribute("logloginsvr")?"https://"+d[0].getAttribute("logloginsvr")+"/":base_url;pollserver_url=null!=d[0].getAttribute("pollserver")?"https://"+d[0].getAttribute("pollserver")+"/":base_url;var e=d[0].getAttribute("pushserver");null!=e&&e.length&&setup_push_listener(e);lpCheckDownloadNewDataFile(d[0].getAttribute("formfillver"),
"ff.dat",ffver,"ff","ff.dat");lpCheckDownloadNewDataFile(d[0].getAttribute("sitesver"),"sites.dat",-1,"sites","sites.dat");lpCheckDownloadNewDataFile(d[0].getAttribute("bigicon"),"bigicons.dat",-1,"bigicon","bigicons.dat");""==d[0].getAttribute("privatekeyenchash")?(console_log("RSA : login response : server returned blank privatekeyenchash : calling generateSharingKeys()"),generateSharingKeys()):(console_log("RSA : login response : server returned privatekeyenchash : calling readrsaprivatekeyhexfromdb() to make sure it matches the local value"),
readrsaprivatekeyhexfromdb(!1,!0,d[0].getAttribute("privatekeyenchash")));(!c||"boolean"==typeof b&&b)&&lpnp_send_internal_logincheck_ack();d=a.responseXML.documentElement;d=d.getElementsByTagName("ok");1==lpGetPref("storeLostOTP",1)&&d[0].hasAttribute("lostpwotpresult")&&"ok"!=d[0].getAttribute("lostpwotpresult")&&0==g_norecovery&&(DeleteOTP(),MakeOTP());hassites()&&g_server_accts_version==g_local_accts_version||(console_log("server.js : !hassites() or server_ver:"+g_server_accts_version+" != local_ver:"+
g_local_accts_version+" so calling get_accts_local!"),get_accts_local());checkIconsVersion(iconsversion);checkBigIconsVersion(null,!1,!0);checkBigIconsVersion(null,!1,!0,"sq");lpretryrequests();if(d[0].getAttribute("sauid0")){a=0;for(b="";d[0].getAttribute("sauid"+a);)(c=lprsa_encryptdata(d[0].getAttribute("sakey"+a),AES.bin2hex(g_local_key)))&&(b+="&sauid"+a+"="+en(d[0].getAttribute("sauid"+a))+"&sakey"+a+"="+en(c)),a++;b.length&&lpMakeRequest(base_url+"uploadsuperkeys.php","cmd=uploadsuperadmin&"+
b,null,null)}}
generateSharingKeys=function(){var a=!1;return function(b){console_log("RSA : generateSharingKeys : generating="+a);if(!a)if(have_binary_function("xGenerateKeys")){console_log("RSA : generateSharingKeys : using xGenerateKeys");a=!0;var c=AES.bin2hex(g_local_key).toUpperCase();call_binary_function("xGenerateKeys",c,function(a){console_log("RSA : generateSharingKeys : xGenerateKeys completed");a=a.split("|");2==a.length?(console_log("RSA : generateSharingKeys : xGenerateKeys was successful -- calling upload_rsa_keys()"),upload_rsa_keys("xGenerateKeys",
{privatekey:atob(a[0]),publickey:atob(a[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys failed")})}else have_pplastpass()?(a=!0,c=AES.bin2hex(g_local_key).toUpperCase(),console_log("RSA : generateSharingKeys : using xGenerateKeys via pplastpass"),pplastpass_send_message({cmd:"xGenerateKeys",userkeyhex:c},function(a){console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass completed");a=a.split("|");2==a.length?(console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass was successful -- calling upload_rsa_keys()"),
upload_rsa_keys("xGenerateKeys",{privatekey:atob(a[0]),publickey:atob(a[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass failed")})):g_ischrome?(console_log("RSA : generateSharingKeys : using Javascript RSAKey() to create sharing keys"),a=!0,c=new RSAKey,generate_key(c,function(a){console_log("RSA : generateSharingKeys : Javascript RSAKey() was successful -- calling upload_rsa_keys()");upload_rsa_keys("RSAKey",a)})):console_log("RSA : generateSharingKeys : Not generating keys since unsupported OS");
b&&b(a)}}();function lpCheckDownloadNewDataFile(a,b,c,d,e){if(""!=a&&0!=a){var f=c;b=localStorage_getItem(e);c=!1;null!=b&&""!=b&&"\n"!=b?(f=-1==b.indexOf("\n")?b.length:b.indexOf("\n"),f=b.substr(0,f)):c=!0;null!=f&&""!=f&&-1!=f&&0<CompareLastPassVersions(a,f)&&(c=!0);c&&lpMakeRequest(base_url+"getappdata.php","type="+en(d),lpDownloadDataResponse,null,e)}}var adminoverride="",lplastgetaccounts=0;
function get_accts(){var a=(new Date).getTime();1E3>a-lplastgetaccounts||(lplastgetaccounts=a,a=base_url+"getaccts.php?mobile=1&b64=1&shap=1&u="+g_username_hash,a+="&includesharedfolderformfillprofiles=1&includeemergencyaccess=1&includependingsharedfolders=1",""!=adminoverride&&(a+="&adminoverride="+en(adminoverride)),lpMakeRequest(a,"",lpAcctsResponse,lpAcctsError))}function get_accts_local(a,b){lpReadAcctsData(a,b)}
function lpAcctsResponse(a){if(a&&4==a.readyState){var b=atob(a.responseText);write_history({cmd:"get_accts_success",sz:b.length,ready_state:a.readyState,status:a.status,lver:g_local_accts_version,sver:g_server_accts_version});lp_enterpriseuser=lp_premium_exp=0;a=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=a?new RegExp(a,"i"):null;g_emer_sharers=[];g_emer_sharees=[];g_totp={};g_note_templates=[];g_reminders=[];parsemobile(b,b.length,100,0,postacctsload,[],[],{},[],[],{},[],!0,!1,
null,[],[],[],[],[],{},lp_rsaprivatekeyhex,[],null,null,null,[],[],[],[],void 0,void 0,g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares,g_reminders);g_premium_exp=lp_premium_exp;g_enterpriseuser=lp_enterpriseuser}else write_history({cmd:"get_accts_fail",sz:a&&"string"==typeof a.responseXML?a.responseXML.length:-1,ready_state:a?a.readyState:-1,status:a?a.status:-1,lver:g_local_accts_version,sver:-1})}
function get_ff_translation(a){var b=lpGetPref("language","");""==b&&(b=navigator.language);var c=b,b=b.replace("-","_");if("es_419"==b||"es_419"==c||"es-419"==c||"es_xl"==b||"es_xl"==c||"es-xl"==c)b="es_MX",c="es-MX";"undefined"==typeof translations[b]&&"undefined"==typeof translations[c]&&(c=b=b.substring(0,2));if("undefined"==typeof translations[b]&&"undefined"==typeof translations[c])for(var d in translations)if(d.substring(0,2)==b){c=b=d;break}"undefined"==typeof translations[b]&&"undefined"==
typeof translations[c]&&(b="en_US",c="en-US");if("undefined"==typeof translations[b]&&"undefined"==typeof translations[c])for(d in c=b="en",translations)if(d.substring(0,2)==b){c=b=d;break}return"undefined"!=typeof translations[b]&&"undefined"!=typeof translations[b][a]&&""!=translations[b][a]?translations[b][a]:"undefined"!=typeof translations[c]&&"undefined"!=typeof translations[c][a]&&""!=translations[c][a]?translations[c][a]:"undefined"!=typeof translations.en_US&&"undefined"!=typeof translations.en_US[a]&&
""!=translations.en_US[a]?translations.en_US[a]:"undefined"!=typeof translations["en-US"]&&"undefined"!=typeof translations["en-US"][a]&&""!=translations["en-US"][a]?translations["en-US"][a]:""}
function rewritelocalfile(a,b,c){c="undefined"==typeof c?null:c;var d=flattendata(g_local_accts_version,g_sites,g_securenotes,g_prompts,g_formfills,g_identities,g_equivalentdomains,g_neverurls,g_premium_exp,lpenc(g_username),g_pendings,g_shareeautopushes,lpmaxid,g_urlrules,g_prefoverrides,g_shares,g_applications,g_enterpriseuser,lp_attaches,g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares),d=btoa(d);if(LPISLOC||c)d="LPB64"+d;d=prependOTPAndEncrypt(d);d=prependIterations(d);lpSaveData(d,
"accts");if(LPISLOC||c){d=lpenc(d);d=prependIterations(d);if(c||lpdisableoffline)return d;protect_data(d,!0,null,function(d){if(have_binary_function("write_file")){var e="";a&&(e="_"+(new Date).toString().replace(" ","_"));e=db_prepend(g_username_hash+e+"_lps.act.sxml");c&&(e="lpexport.xml");call_binary_function("write_file",e,d)}a||b||lpnp_notify("refresh_local",{data0:g_username_hash})})}update_menus(!0)}
function prependOTPAndEncrypt(a){var b=null,c="";sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")?(lpdbg("sesame","encrypting accounts file before writing"),b=sesame_getdata("password_offline"),c="type=sesameoffline\ndata="):multifactor_getdata("password_offline")&&""!=multifactor_getdata("password_offline")?(lpdbg("multifactor","encrypting accounts file before writing"),b=multifactor_getdata("password_offline"),c="type="+multifactor_getdata("type")+"offline\ndata="):yubikey_getdata("password_offline")&&
""!=yubikey_getdata("password_offline")&&(lpdbg("yubikey","encrypting accounts file before writing"),b=yubikey_getdata("password_offline"),c="type=yubikeyoffline\ndata=");if(b){a=enc(a,hex2bin(b));if(!a||""==a)return lpdbg("error","Failed to encrypt data in save_accounts_fileraw"),!1;a=c+a}return a}
function clearSavedPassword(a){var b=opendb();createSavedLoginsTable(b);b&&(console_log("server.js : clearing saved credentials"),g_indexeddb?b.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(a)).onsuccess=function(a){a.target.result&&""!=a.target.result.value.password&&(a.target.result.value.password="",b.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(a.target.result.value))}:b.transaction(function(b){b.executeSql("UPDATE LastPassSavedLogins2 SET password = '' WHERE username = ?",
[a])}))}function checkforknownhackedsites(){}
function postacctsload(a,b,c,d,e,f,h,g,k,l,n,q,r,p,x,A,v,t,u,z,y,B){if(lploggedin)if(g||l&&(!l||0!=a.length)){try{if(null!=lp_trueapi_trial_exp){var C=parseInt(lp_trueapi_trial_exp);0<C&&C<parseInt((new Date).getTime()/1E3)&&(getsinglefactortype(function(a){"trueapi"==a&&setsinglefactortype("")}),"trueapi"==multifactor_getdata("type")&&multifactor_setdata("type",""))}}catch(D){}if(0<a.length&&"undefined"!=typeof n&&null!=n&&""==adminoverride&&(g=lpdec(n),""!=n&&null!=n&&"null"!=n&&g_username!=g))return lpReportError("Encrypted username check failed: "+
g_username+" vs "+g+" for "+n+" local "+l,null),lpshowError("A consistency check failed while loading your sites. Please relogin."),clearSavedPassword(g_username),clearAllData(),loggedOut(!1,"encryptedusername_check_failed"),!1;lpmaxid=p.maxid;l||(k=btoa(k),k=prependOTPAndEncrypt(k),k=prependIterations(k),lpSaveData(k,"accts"));k={};g_tlds={};n=AES.bin2hex(g_local_key);for(var m=0;m<a.length;m++){a[m].url=AES.hex2url(a[m].url);a[m].tld=lp_gettld_url(a[m].url);if(LPISLOC&&a[m].tld)try{var w=function(){rfdefaults&&
"undefined"!=typeof rfdefaults[a[m].tld]&&(a[m].submit_id=rfdefaults[a[m].tld].submit_id,a[m].captcha_id=rfdefaults[a[m].tld].captcha_id,a[m].custom_js=rfdefaults[a[m].tld].custom_js)};rfdefaults?w():lpReadFile("rfdefaults",function(a){rfdefaults=JSON.parse(lp_hex2bin(a));w()})}catch(D){}p="undefined"==typeof a[m].sharefolderid?g_local_key:getsharekey(t,a[m].sharefolderid);null!=p&&(g="undefined"==typeof a[m].sharefolderid?n:AES.bin2hex(p),a[m].unencryptedUsername=lpmdec(a[m].username,!0,p,g));"undefined"==
typeof g_tlds[a[m].tld]&&(g_tlds[a[m].tld]={});g_tlds[a[m].tld][a[m].aid]=!0;k[a[m].aid]=a[m]}n={};for(m=0;m<b.length;m++)b[m].url=AES.hex2url(b[m].url),n[b[m].aid]=b[m];p={};for(m=0;m<u.length;m++)u[m].appname=AES.hex2url(u[m].appname),p[u[m].appaid]=u[m];g_sites=k;g_securenotes=n;g_applications=p;g_prompts=c;g_formfills=d;g_identities=e;g_equivalentdomains=f;g_urlrules=x;g_neverurls=h;g_pendings=q;g_prefoverrides=v;g_shares=t;lp_attaches=z;0<g_shares.length&&("undefined"==typeof lp_rsaprivatekeyhex||
null==lp_rsaprivatekeyhex||""==lp_rsaprivatekeyhex)&&"undefined"==typeof g_keyloopprotection&&setTimeout(function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex?(g_keyloopprotection=!0,get_accts_local()):(g_keyloopprotection=!0,console_log("RSA : post accounts load : calling readrsaprivatekeyhexfromdb()"),readrsaprivatekeyhexfromdb(!0,!0,null,function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex&&get_accts()}))},5E3);overrideprefs(g_prefoverrides);setcachedffdat();g_shareeautopushes=[];parseAutoPushMobile(r,
g_shareeautopushes);for(m=0;m<g_formfills.length;m++)g_formfills[m].decprofilename=lpmdec_acct(g_formfills[m].profilename,!0,g_formfills[m],g_shares);g_formfills.sort(function(a,b){return a.decprofilename.toLowerCase()<b.decprofilename.toLowerCase()?-1:1});if("undefined"==typeof g_identity||null==g_identity)g_identity="";c=!1;for(m=0;m<g_identities.length;m++)g_identities[m].deciname=lpdec(g_identities[m].iname),g_identities[m].iid==g_identity&&(c=!0);g_identities.sort(function(a,b){return a.deciname.toLowerCase()<
b.deciname.toLowerCase()?-1:1});if(!c&&""!=g_identity)return identityFilter="",switch_identity("",!0),clearCache(!0,!1,!1),setTimeout(function(){loggedOut(!1,"wrongidentity")},500),console_log("Identity: "+g_identity),alertfrombg(gs("Your selected Identity no longer exists. Defaulting to 'All' and logging off.")),!1;rsa_acceptpendingshares();rsa_acceptshareeautopushes();w=function(a){a=(null==a?"":a).split("\n");for(var b=0;b<a.length;b++){var c=a[b].split(" ");if(2==c.length&&""!=c[0]&&""!=c[1]){var d=
c[0],c=c[1];g_sites[d]&&c>g_sites[d].last_touch&&(g_sites[d].last_touch=c)}}};c="";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lt.cac"),w):("undefined"!=typeof localStorage&&(c=localStorage_getItem(db_prepend(g_username_hash+"_lt.cac"))),w(c));if("undefined"!=typeof foundmsfi&&0==l){postdata="";l=0;for(m in msfids){f=msfids[m].shareid;e="";c=null;for(d=0;d<g_shares.length;d++)if(g_shares[d].id==f){e=AES.bin2hex(g_shares[d].key);
c=g_shares[d].decsharename;break}null!==c&&(f=new RSAKey,parse_public_key(f,msfids[m].key)&&(e=f.encrypt(e),d=lpenc(c,g_shares[d].key),postdata+="&sharekey"+l+"="+encodeURIComponent(e)+"&uid"+l+"="+encodeURIComponent(msfids[m].uid),postdata+="&shareid"+l+"="+encodeURIComponent(msfids[m].shareid),postdata+="&decsharename"+l+"="+encodeURIComponent(c),postdata+="&encsharename"+l+"="+encodeURIComponent(d),l++))}l=0;lpMakeRequest(base_url+"process_msf.php",postdata,null,null)}console_log("server.js : num sites: "+
a.length+" num sn: "+b.length+" num ff: "+g_formfills.length+" num identities: "+g_identities.length+" pendings: "+g_pendings.length+" num applications: "+g_applications.length);recheckall();update_menus(!0);"undefined"!=typeof y&&y.attachversion>lp_server_attach_version&&(console.log("setting lp_server_attach_version="+y.attachversion),lp_server_attach_version=y.attachversion);g_runchallenge?setTimeout(function(){runChallenge()},1E4):fix_sites_secure_reprompt();"undefined"!=typeof B&&"function"==
typeof handle_pending_pushed_sites&&handle_pending_pushed_sites(B,function(){get_accts()},g_shares);checkBigIconsVersion();checkBigIconsVersion(null,null,null,"sq");checkforknownhackedsites();if("undefined"!=typeof share_folder_group&&""!=share_folder_group&&"undefined"!=typeof share_folder_id&&""!=share_folder_id)for(m=0;m<t.length;m++)if(t[m].id==share_folder_id){b=share_folder_group;set_share_folder_group("");set_share_folder_id("");renameGroup(b,t[m].decsharename);break}}else console_log("server.js : ERROR: Could not parse accts data!!!"),
gPulledInvalidAccts?lpshowError("ErrorGetAcctsMsg"):(gPulledInvalidAccts=!0,get_accts())}function setcachedffdat(){for(var a=localStorage_getItem("ff.dat"),a=null==a?translations:LPJSON.parse(a),b=[],c=0;c<g_formfills.length;c++)b[lpmdec_acct(g_formfills[c].profilelanguage,!0,g_formfills[c],g_shares)]=1;var d=[];for(c in a)if("en-US"==c||"undefined"!=typeof b[c])d[c]=a[c];g_cachedffdat=LPJSON.stringify(d)}
function overrideprefs(a){"undefined"!=typeof a.allowmasterpasswordsave&&"0"==a.allowmasterpasswordsave?(lpPutGblPref("rememberpassword",0),g_master_password_saved=!1,deletesavedpw(),localStorage_setItem(g_username_hash+".noremember",1)):localStorage_removeItem(g_username_hash+".noremember");"undefined"!=typeof a.logoffclosebrowser&&"-1"!=a.logoffclosebrowser&&(lpPutGblPref("logoffWhenCloseBrowser",1),lpPutGblPref("logoffWhenCloseBrowserVal",a.logoffclosebrowser));"undefined"!=typeof a.logoffidle&&
"-1"!=a.logoffidle&&(lpdbg("idle","overriding idleLogoffVal with value from server: "+a.logoffidle),lpPutUserPref("idleLogoffVal",a.logoffidle));"undefined"!=typeof a.noexport&&"-1"!=a.noexport&&lpPutUserPref("noexport",a.noexport);lpWriteAllPrefs();LP.sitepwlen="string"==typeof a.sitepwlen&&""!=a.sitepwlen?JSON.parse(a.sitepwlen):[];"undefined"!=typeof a.hideidentities&&"-1"!=a.hideidentities&&(g_hideidentities="1"==a.hideidentities);g_savesitestopersonal="string"==typeof a.savesitestopersonal&&
""!=a.savesitestopersonal?a.savesitestopersonal.split(","):[]}function lpAcctsError(){L("Error xhr_accts")}function loglogin(a){get_selected_tab(null,function(b){logloginurl(a,b)})}function tab_is_private(a){return g_isfirefoxsdk?g_private_browsing.isPrivate(a):"undefined"!=typeof a.incognito&&a.incognito}function loglogintab(a,b){tab_is_private(b)||logloginurl(a,gettaburl(b))}
function logloginurl(a,b){var c=lp_get_gmt_timestamp();if("undefined"!=typeof g_sites[a]){if(parseFloat(c)<5+parseFloat(g_sites[a].last_touch))return;g_sites[a].last_touch=c;writenewts(a,c)}else if("undefined"!=typeof g_securenotes[a]){if(c==g_securenotes[a].last_touch)return;g_securenotes[a].last_touch=lp_get_gmt_timestamp();rewritelocalfile();if(!g_loglogins||4!=(g_loglogins&4))return}if(g_loglogins&&(c=getacct(a))){var d=issharedfolder(g_shares,c.group);if(!d||d.id!==get_personal_linked()){var e=
(new PostParams).add("id",a).add("method",get_method());1<g_loglogins&&c&&(2==(g_loglogins&2)&&"http://sn"!=c.url&&e.add("u",AES.url2hex(b)),4==(g_loglogins&4)&&e.add("n",AES.url2hex(c.name)),8==(g_loglogins&8)&&e.add("un",AES.url2hex(getusernamefromacct(c))));d&&e.add("sharedfolderid",d.id);lpMakeRequest(loglogin_url+"loglogin.php",e.toString(),null,null)}}}
function logmpwreuse(a){if(requirechangereuse()||g_loglogins)a="plog=1&u="+encodeURIComponent(a),lpMakeRequest(loglogin_url+"loglogin.php",a,null,null)}
function writenewts(a,b){var c=function(c){c=(null==c?"":c).split("\n");for(var d="",e=0;e<c.length;e++)0!=c[e].indexOf(a+" ")&&""!=c[e]&&(d+=c[e]+"\n");d+=a+" "+b+"\n";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("write_file")&&call_binary_function("write_file",db_prepend(g_username_hash+"_lt.cac"),d);"undefined"!=typeof localStorage&&localStorage_setItem(db_prepend(g_username_hash+"_lt.cac"),d)},d="";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",
db_prepend(g_username_hash+"_lt.cac"),c):("undefined"!=typeof localStorage&&(d=localStorage_getItem(db_prepend(g_username_hash+"_lt.cac"))),c(d))}
function logformfill(a,b,c){get_selected_tab(null,function(d){if(!tab_is_private(d)&&g_loglogins){d=(new PostParams).add("ffid",a).add("method",get_method());for(var e=0;e<g_formfills.length;e++)if(g_formfills[e].ffid==a){(e=issharedfolder(g_shares,"undefined"!=typeof g_formfills[e].group?g_formfills[e].group:""))&&d.add("sharedfolderid",e.id);break}b&&d.add("u",bin2hex(b));c&&d.add("source",c);lpMakeRequest(base_url+"logformfill.php?"+d.toString(),"",null,null)}})}
var PostParams=function(a){this.params={};for(var b in a)this.add(b,a[b])};
(function(){PostParams.prototype.add=function(a,b,c){!a||"string"!==typeof a||"boolean"!==typeof b&&"number"!==typeof b&&"string"!==typeof b||!c&&this.params.hasOwnProperty(a)||(this.params[a]=String(b));return this};PostParams.prototype.remove=function(a){a&&"string"===typeof a&&this.params.hasOwnProperty(a)&&delete this.params[a];return this};PostParams.prototype.clear=function(){this.params={};return this};PostParams.prototype.toString=function(){var a="",b;for(b in this.params)this.params.hasOwnProperty(b)&&
(""!=a&&(a+="&"),a+=encodeURIComponent(b)+"="+encodeURIComponent(this.params[b]));return a}})();function logclearform(a,b){get_selected_tab(null,function(c){!tab_is_private(c)&&g_loglogins&&(c=(new PostParams).add("ffclear",1).add("method",get_method()),b&&c.add("source",b),a&&c.add("u",bin2hex(a)),lpMakeRequest(base_url+"logformfill.php?"+c.toString(),"",null,null))})}
function lpCreateKeyFileData(){if("undefined"!=typeof g_pwdeckey&&null!=g_pwdeckey&&"undefined"!=typeof g_local_key&&null!=g_local_key){var a=AES.bin2hex(g_local_key),a=AES.Encrypt({pass:g_pwdeckey,data:a,b64:!0,mode:"ecb",bits:256}),b=AES.Encrypt({pass:g_local_key,data:"lastpass rocks",b64:!0,mode:"ecb",bits:256});return a+"\n"+b}return""}
function lpWriteKeyFile(){console_log("server.js : lpWriteKeyFile : start");var a=lpCreateKeyFileData();""!=a?(console_log("server.js : lpWriteKeyFile : calling lpSaveData"),lpSaveData(a,"key"),(g_is_win||g_is_mac||g_is_linux)&&have_binary_function("write_file")?(console_log("server.js : lpWriteKeyFile : calling protect_data"),protect_data(a,!0,null,function(a){console_log("server.js : lpWriteKeyFile : protect_data callback");console_log("server.js : lpWriteKeyFile : calling binary function to write keyfile");
call_binary_function("write_file",db_prepend(g_username_hash+"_lpall.slps"),a)})):console_log("server.js : lpWriteKeyFile : did not have binary function, so not writing")):console_log("server.js : lpWriteKeyFile : not writing A")}
function lpReadKeyFile(a,b,c,d){console_log("server.js : lpReadKeyFile fromwebsite="+b+" silent="+c+" bIsLoginCheck="+d);c=opendb();createDataTable(c);if(c){console_log("server.js : lpReadKeyFile : reading db");console_log("server.js : lpReadKeyFile : starting db transaction");var e=function(c,e){console_log("server.js : lpReadKeyFile : reading numrows="+e.rows.length);if(0<e.rows.length){var f=e.rows.item(0).data;if(f)if(f=f.split("\n"),2==f.length){var g;g=a?AES.hex2bin(lpdec(f[0],g_pwdeckey)):
g_local_key;if("lastpass rocks"==lpdec(f[1],g)){g_local_key=g;g_local_key_hex=AES.bin2hex(g);g_local_key_hash=SHA256(g_local_key);if(a){console_log("server.js : lpReadKeyFile : worked -- calling lpLoginResponse_win2");lpLoginResponse_win2(a,b,d);return}loggedIn();console_log("server.js : lpReadKeyFile worked -- calling get_accts_local");get_accts_local(!0)}else console_log("server.js : lpReadKeyFile : data was corrupt A")}else console_log("server.js : lpReadKeyFile : data was corrupt B");else console_log("server.js : lpReadKeyFile : did not find any data")}else console_log("server.js : lpReadKeyFile : failed to read -- calling lp_login_from_saved"),
lp_login_from_saved();a&&loggedOut(!1,"keyfailed")},f=function(a,b){console_log("server.js : lpReadKeyFile failed error="+b)};if(LPISLOC)console_log("server.js : lpReadKeyFile calling read_key_from_file"),read_key_from_file(function(a){console_log("server.js : lpReadKeyFile read_key_from_file callback");""!=a?e(tx,{rows:{length:1,item:function(b){return{data:a}}}}):e(tx,{rows:{length:0}})});else if(console_log("server.js : lpReadKeyFile calling executeSql"),g_indexeddb){var h={rows:{item:function(a){return this[a]},
length:0}};c.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=function(a){(a=a.target.result)?(h.rows[h.rows.length]=a.value,h.rows.length++,a["continue"]()):e(null,h)}}else c.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],e,f)})}else console_log("server.js : lpReadKeyFile : failed to open database")}
function lpCheckForKey(a){var b=opendb();createDataTable(b);if(b){var c=function(b,c){0<c.rows.length?a():console_log("no key")},d=function(a,b){console_log(b)};if(LPISLOC)read_key_from_file(function(a){""!=a?c(tx,{rows:{length:1,item:function(b){return{data:a}}}}):c(tx,{rows:{length:0}})});else if(g_indexeddb){var e={rows:{item:function(a){return this[a]},length:0}};b.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=
function(a){(a=a.target.result)?(e.rows[e.rows.length]=a.value,e.rows.length++,a["continue"]()):c(null,e)}}else b.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],c,d)})}}
function lpReadAcctsData(a,b,c,d){function e(a){"string"==typeof a&&(h=a);write_history({cmd:"get_accts_local",status_s:h,sz:f,lver:g_local_accts_version,sver:g_server_accts_version})}if(null==g_username||""==g_username)e("error");else{var f=-1,h="ok",g=opendb();createDataTable(g);if(g){var k=function(g,h){if(0<h.rows.length){if((data=h.rows.item(0).data)&&""!=data){data=checkIterationsInDataFile(data);if("iterationserror"==data){console_log("server.js : local accts data corrupt - key mismatch. redownloading");
e("error");get_accts();return}if(a&&!(sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")&&yubikey_getdata("password_offline")&&""!=yubikey_getdata("password_offline")&&multifactor_getdata("password_offline")&&""!=multifactor_getdata("password_offline"))){if(0==data.substring(0,30).indexOf("type=sesameoffline\ndata=")){sesame_setdata("offline","1");sesame_getotp(g_username);return}if(0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")||0==data.substring(0,30).indexOf("type=omnikeyoffline\ndata=")){multifactor_setdata("offline",
"1");multifactor_setdata("type",0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")?"trueapi":"omnikey");multifactor_getresponse(g_username);return}if(0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata=")){yubikey_setdata("offline","1");yubikey_getotp(g_username);return}}var k=null;sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=sesameoffline\ndata=")?(lpdbg("sesame","decrypting accounts file after reading"),data=
data.substring(24),k=sesame_getdata("password_offline")):!multifactor_getdata("password_offline")||""==multifactor_getdata("password_offline")||0!=data.substring(0,30).indexOf("type=trueapioffline\ndata=")&&0!=data.substring(0,30).indexOf("type=omnikeyoffline\ndata=")?yubikey_getdata("password_offline")&&""!=yubikey_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata=")&&(lpdbg("yubikey","decrypting accounts file after reading"),data=data.substring(25),k=yubikey_getdata("password_offline")):
(lpdbg("multifactor","decrypting accounts file after reading"),data=data.substring(25),k=multifactor_getdata("password_offline"));k&&(data=dec(data,hex2bin(k)))}LPISLOC&&5<=data.length&&"LPB64"==data.substring(0,5)&&(data=data.substring(5));try{data=atob(data),f=data.length,c&&d(data)}catch(x){console_log("server.js : local accts data corrupt. redownloading");e("error");get_accts();return}k=get_version(data);if(k!=g_server_accts_version&&-1!=g_server_accts_version)console_log("server.js : local accts version is outdated: local:"+
k+" server:"+g_server_accts_version+" redownloading"),get_accts();else{L("using cached accts data");if(hassites()&&(!b||"refetchsharing"!=b)){L("Cached data already in place, ABORT, to avoid reparse.");e("abort");return}lp_enterpriseuser=lp_premium_exp=0;k=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=k?new RegExp(k,"i"):null;parsemobile(data,data.length,100,0,postacctsload,[],[],{},[],[],{},[],!0,!0,null,[],[],[],[],[],{},lp_rsaprivatekeyhex,[],null,null,null,[],[],[],[],void 0,void 0,
g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares,g_reminders);g_premium_exp=lp_premium_exp;g_enterpriseuser=lp_enterpriseuser}}else g_username_hash&&get_accts();e()},l=function(a,b){console_log(b);h="error"};if(LPISLOC)read_accts_from_file(function(a){""!=a?k(tx,{rows:{length:1,item:function(b){return{data:a}}}}):k(tx,{rows:{length:0}})});else if(g_indexeddb){var n={rows:{item:function(a){return this[a]},length:0}};g.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+
"_accts")).onsuccess=function(a){(a=a.target.result)?(n.rows[n.rows.length]=a.value,n.rows.length++,a["continue"]()):k(null,n)}}else g.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),"accts"],k,l)})}else get_accts()}}
function MakeOTP(){if(null!=g_username&&0!=g_username.length&&null!=g_local_key&&0!=g_local_key.length){var a=fix_username(g_username);rng_seed_time();for(var b=[],c=0;16>c;c++)b[c]=0;rng_get_bytes(b);for(var d="",c=0;16>c;c++)d+=String.fromCharCode(b[c]);var b=enc(AES.bin2hex(d),g_local_key),e=make_lp_key(g_username,d),c=enc(AES.bin2hex(g_local_key),e),a=SHA256(SHA256(a+d)+d),f=AES.hex2bin(dec(c,e,1));g_local_key!=f?console_log("server.js : ERROR: Failed to decrypt newly encrypted key: dec_local_key:\n"+
AES.bin2hex(f)+" != \n"+AES.bin2hex(g_local_key)+"\nlen: "+f.length+" vs "+g_local_key.length+"\nrand pw:"+AES.bin2hex(d)+"\ng_username:"+g_username+"\nrand key:"+AES.bin2hex(e)+"\nrand_encrypted_key:"+c):(a="newkey=1&xml=1&hash="+LP.en(a),a+="&encrypted_otp="+LP.en(b),a+="&rand_encrypted_key="+LP.en(c),LP.lpMakeRequest(base_url+"otp.php",a+"&recovery=1",lpOTPUploadResponse,function(){},d))}}function DeleteOTP(){DeleteFromDB("otp")}
function DeleteFromDB(a){if(null!=g_username&&""!=g_username&&(!LPISLOC||"key"!=a&&"accts"!=a)){var b=opendb();createDataTable(b);if(b)if(g_indexeddb)b.transaction("LastPassData","readwrite").objectStore("LastPassData")["delete"](db_prepend(g_username_hash)+"_"+a);else b.transaction(function(b){b.executeSql("DELETE FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),a],function(a,b){},function(a,b){console_log(b)})})}}
function GetOTPHash(a,b,c,d){a&&(a+="&outofbandsupported=1",isDogfood()&&(a+="&dogfood=1"));var e=opendb();createDataTable(e);if(e){var f=c?SHA256(c):g_username_hash,h=c?c:g_username,g=function(c,e){var f="";0<e.rows.length&&(f=e.rows.item(0).data);a?(""!=f?(f=AES.hex2bin(f),lostotphash=SHA256(SHA256(fix_username(h)+f)+f)):lostotphash="",1==lpGetPref("storeLostOTP",1)&&(a+="&lostpwotphash="+en(lostotphash)),sesame_setdata("postdata",a),yubikey_setdata("postdata",a),googleauth_setdata("postdata",a),
outofband_setdata("postdata",a),securityquestion_setdata("postdata",a),grid_setdata("postdata",a),multifactor_setdata("postdata",a),g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php A"),lpMakeRequest(base_url+"login.php",a,lpLoginResponse,lpLoginError)):null!=b&&(lostotphash=""==f?"nouser":f,sendCS(b,{cmd:"recover",otp:lostotphash},d))};if(g_indexeddb){var k={rows:{item:function(a){return this[a]},length:0}};e.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(f)+
"_otp")).onsuccess=function(a){(a=a.target.result)?(k.rows[k.rows.length]=a.value,k.rows.length++,a["continue"]()):g(null,k)}}else e.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(f),"otp"],g,function(a,b){console_log(b)})})}else g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php B"),lpMakeRequest(base_url+"login.php",a,lpLoginResponse,lpLoginError)}
function lpOTPUploadResponse(a,b,c){4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement&&(a=opendb(),createDataTable(a),a&&(g_indexeddb?a.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:db_prepend(g_username_hash),type:"otp",data:AES.bin2hex(c),usertype:db_prepend(g_username_hash)+"_otp"}):a.transaction(function(a){a.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, ?, ?)",[db_prepend(g_username_hash),"otp",
AES.bin2hex(c)],function(a,b){console_log("server.js : inserted")},function(a,b){console_log(b)})})))}
fillGeneratedPassword=function(){var a=function(a,c,d,e){c={cmd:"populategeneratedpassword",url:c,password:d};sendLpImprove("genpassword",c.saveOptions);sendCS(a,c)};return function(b,c,d,e){LPContentScriptFeatures.new_save_site?b?a(b,c,d,e):get_selected_tab_data(null,function(b){a(b.id,b.url,d,e)}):b?(g_checkgeneratepasswordcallback=function(){savePassword(d,c,b,!0,e)},checkgeneratepassword(b)):get_selected_tab_data(null,function(a){fillGeneratedPassword(a.id,a.url,d,e)})}}();
function savePassword(a,b,c,d,e){var f=lp_gettld_url(b);if(0==b.indexOf("chrome://")||0==b.indexOf("chrome-extension://"))f=b="Browser";f=gs("Generated Password for")+" "+f;a=(new PostParams).add("url",AES.url2hex(b)).add("password",lpenc(a)).add("name",lpenc(f)).add("iid",g_identity).add("method",get_method()).add("token",g_token);d&&a.add("nofill",1);for(prop in e)a.add(prop,e[prop]);lpMakeRequest(base_url+"save_gen_pw.php",a.toString(),lpPopulateGeneratedPassword,null,c)}
function lpPopulateGeneratedPassword(a,b,c){if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;b=a.getElementsByTagName("error");if(0<b.length&&(b=b[0].getAttribute("notloggedin"))&&"1"==b){loggedOut(!1,"lpPopulateGeneratedPassword");return}a=a.getElementsByTagName("ok");if(0<a.length){b=AES.hex2url(a[0].getAttribute("url"));var d=crypto_atob(a[0].getAttribute("password")),e={cmd:"populategeneratedpassword",url:b,password:lpmdec(d,!0),
nofill:a[0].getAttribute("nofill"),ff_currpass_regexp:get_ff_translation("ff_currpass_regexp")};sendCS(c,e,"all");c=createNewAcct();c.tld=lp_gettld_url(b);e=gs("Generated Password for")+" "+c.tld;c.aid=a[0].getAttribute("aid");"undefined"==typeof g_tlds[c.tld]&&(g_tlds[c.tld]={});g_tlds[c.tld][c.aid]=!0;add_ident_aid(c.aid);c.url=b;c.name=e;c.password=d;c.genpw=1;g_sites[c.aid]=c;g_local_accts_version++;rewritelocalfile();c=a[0].getAttribute("accts_version");compare_accounts_versions(c,g_local_accts_version)||
get_accts();refresh_windows()}}}function addeditformfill(a,b,c,d){var e=(new PostParams).add("method",get_method()).add("token",g_token).add("iid",g_identity),f;for(f in a)e.add(f,a[f]);a=!1;"undefined"!=typeof b.group&&""!=b.group&&(a=issharedfolder(g_shares,b.group));a&&e.add("sharedfolderid",a.id);lpMakeRequest(base_url+"formfill.php",e.toString(),lpAddEditFormFillResponse,d,{site:b,successCallback:c,errorCallback:d});return!0}
function deleteformfill(a,b,c,d,e,f,h){if(c&&!frame_and_topdoc_has_same_domain(d)&&(ftd_report_error(d,"deleteformfill"),!lpConfirmYesNo(gs("Are you sure you would like to delete this Form Fill from your LastPass vault?"))))return!1;var g;if(!b)for(g=0;g<g_formfills.length;g++)if(g_formfills[g].ffid==a){if(g_formfills[g].pwprotect||g_prompts.view_ff_prompt)return security_prompt(function(){deleteformfill(a,!0,c,d,e,f,h)}),!1;break}b=!1;for(g=0;g<g_formfills.length;g++)if(g_formfills[g].ffid==a){b=
issharedfolder(g_shares,"undefined"!=typeof g_formfills[g].group?g_formfills[g].group:"");g_formfills.splice(g,1);break}g_local_accts_version++;rewritelocalfile();g=(new PostParams).add("deleteext",1).add("ffid",a).add("method",get_method()).add("iid",g_identity);h&&g.add("source",h);b&&g.add("sharedfolderid",b.id);lpMakeRequest(base_url+"formfill.php",g.toString(),lpDeleteFormFillResponse,f,{ffid:a,successCallback:e,errorCallback:f});return!0}
function lpAddEditFormFillResponse(a,b,c){b=c.site;if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;var d=a.getElementsByTagName("error");if(0<d.length){var e=d[0].getAttribute("notloggedin");if(e&&"1"==e){loggedOut(!1,"lpAddEditFormFillResponse");return}(d=d[0].getAttribute("response"))&&(c.errorCallback?c.errorCallback(d):alertfrombg(d))}d=a.getElementsByTagName("result");if(0<d.length){d[0].getAttribute("msg");a=d[0].getAttribute("ffid");
for(var f=d[0].getAttribute("cfids"),d=d[0].getAttribute("accts_version"),e=[],h=""==f?[]:f.split(","),g=0,f=1;"undefined"!=typeof b["customfield"+f+"cfid"];++f){var k={};k.cfid=0!=b["customfield"+f+"cfid"]?b["customfield"+f+"cfid"]:g<h.length?h[g++]:0;k.text=b["customfield"+f+"text"];k.value=b["customfield"+f+"value"];k.alttext=b["customfield"+f+"alttext"];""==k.text&&""==k.value&&""==k.alttext||e.push(k)}h=b.cmd;delete b.cmd;delete b.deleteext;for(f=1;"undefined"!=typeof b["customfield"+f+"cfid"];++f)delete b["customfield"+
f+"cfid"],delete b["customfield"+f+"text"],delete b["customfield"+f+"value"],delete b["customfield"+f+"alttext"];b.custom_fields=e;if("add"==h)b.ffid=a,add_ident_ffid(a),g_formfills.push(b);else for(f=0;f<g_formfills.length;++f)if(a==g_formfills[f].ffid){g_formfills[f]=b;break}g_formfills.sort(function(a,b){return a.decprofilename.toLowerCase()<b.decprofilename.toLowerCase()?-1:1});g_local_accts_version++;rewritelocalfile();compare_accounts_versions(d,g_local_accts_version)||get_accts();refresh_windows();
c.successCallback&&c.successCallback(b);do_experimental_popupfill&&setTimeout(function(){recheckpage()},50)}}}
function lpDeleteFormFillResponse(a,b,c){if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;b=a.getElementsByTagName("error");if(0<b.length&&(b=b[0].getAttribute("notloggedin"))&&"1"==b){loggedOut(!1,"lpDeleteFormFillResponse");return}a=a.getElementsByTagName("result");0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows(),c.successCallback&&c.successCallback(),
do_experimental_popupfill&&setTimeout(function(){recheckpage()},50))}}
function saveSiteFromSubmit(a,b,c,d){var e=(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity),f=IntroTutorial.getState();f&&f.enabled&&(e.add("intour","1"),e.add("tile",f.tile));try{for(var h in g_sites)if(g_sites[h].genpw&&g_sites[h].tld==b.tld&&lpmdec_acct(g_sites[h].password,!0,g_sites[h],g_shares)==lpmdec_acct(b.password,!0,b,g_shares)){e.add("delgenpwaid",h);e.add("generated","true");break}}catch(g){}a+="&"+e.toString();b={url:base_url+"deliver_and_add.php",postdata:a,
successCallback:c,errorCallback:d,acct:b};handleOfflineAccountUpdate(b,g_sites,"aid");lpMakeRequest(b.url,a,lpSaveSiteResponse,d,b)}function updateFieldsFromSubmit(a,b,c,d){a+="&auto=1"+get_identity_param();b={url:base_url+"gm_deliver.php",postdata:a,acct:b,successCallback:c,errorCallback:d};lpMakeRequest(b.url,a,lpUpdateFieldsResponse,null,b)}
function handleOfflineAccountUpdate(a,b,c){if(a.successCallback&&isOffline()){if("0"===a.acct[c]){var d=Preferences.get("tempID")+1;a.acct[c]=d.toString();Preferences.set("tempID",d)}b[a.acct[c]]=a.acct;a.successCallback(a.acct);increment_local_accts_version();rewritelocalfile();delete a.successCallback;delete a.errorCallback}}
function saveAllSite(a,b,c,d){var e=(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity);a+="&"+e.toString();b={url:base_url+"show.php",postdata:a,successCallback:c,errorCallback:d,acct:b};handleOfflineAccountUpdate(b,g_sites,"aid");lpMakeRequest(b.url,a,lpSaveSiteResponse,b.errorCallback,b)}
function saveSite(a,b,c,d){var e=(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity);try{for(var f in g_sites)if(g_sites[f].genpw&&g_sites[f].tld==b.tld&&lpmdec_acct(g_sites[f].password,!0,g_sites[f],g_shares)==lpmdec_acct(b.password,!0,b,g_shares)){e.add("delgenpwaid",f);e.add("generated","true");break}}catch(h){}a+="&"+e.toString();e=is_application(b);c={url:base_url+(e?"addapp.php":"show.php"),postdata:a,successCallback:c,errorCallback:d,acct:b};handleOfflineAccountUpdate(c,
b.sn?g_securenotes:e?g_applications:g_sites,e?"appaid":"aid");lpMakeRequest(c.url,a,lpSaveSiteResponse,c.errorCallback,c)}function openLinkedSites(a,b,c){setTimeout(function(){openchangepw(a,b,c)},700)}
function lpSaveSiteResponse(a,b,c){c.aid=c.acct.aid;c.newvalues=c.acct.newvalues;c.handler=lpSaveSiteResponse;if(!rsa_shareeautopushesresponse(a,c)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){b=c.acct;var d=a.responseXML.documentElement;a=d.getElementsByTagName("error");if(0<a.length){var e=a[0].getAttribute("notloggedin");if(e&&"1"==e){loggedOut(!1,"lpSaveSiteResponse");return}(a=a[0].getAttribute("response"))&&(c.errorCallback?c.errorCallback(a):alertfrombg(a))}e=
d.getElementsByTagName("result");if(0<e.length){a=0;("accountreplaced"==e[0].getAttribute("msg")||c.successCallback)&&a++;b.submit_id=e[0].getAttribute("submit_id");b.captcha_id=e[0].getAttribute("captcha_id");b.custom_js=e[0].getAttribute("custom_js");var f=e[0].getAttribute("attacherror");f&&""!=f&&alertfrombg(f);checkIconsVersion();checkBigIconsVersion(b.posturl);checkBigIconsVersion(b.posturl,null,null,"sq");inc=0;for(newattach=[];null!=e[0].getAttribute("att_"+inc);)newattach[e[0].getAttribute("att_"+
inc)]=[],newattach[e[0].getAttribute("att_"+inc)].key=e[0].getAttribute("attstorekey_"+inc),newattach[e[0].getAttribute("att_"+inc)].size=e[0].getAttribute("attsize_"+inc),inc++;var h=is_application(b)?"0"===b.appaid:"0"===b.aid;if(h){var g=e[0].getAttribute("aid"),k=e[0].getAttribute("urid");b.aid=b.fiid=g;b.urid=k;if(b.fields)for(var l=get_ff_translation("ff_captcha_regexp"),g=""!=l?new RegExp(l,"i"):null,l=0;l<b.fields.length;l++)b.fields[l].otherfield||"1"==b.fields[l].otherlogin||(b.fields[l].urid=
k),g&&("undefined"==typeof b.captcha_id||""==b.captcha_id)&&"text"==b.fields[l].type&&g.exec(b.fields[l].name)&&(b.captcha_id=b.fields[l].name);add_ident_aid(b.aid);if(b.sn)g_securenotes[b.aid]=b;else{if("undefined"==typeof b.tld||""==b.tld)b.tld=lp_gettld_url(b.url);"undefined"==typeof g_tlds[b.tld]&&(g_tlds[b.tld]={});g_tlds[b.tld][b.aid]=!0;g_sites[b.aid]=b}for(l in g_sites)g_sites[l].genpw&&g_sites[l].tld==b.tld&&lpmdec_acct(g_sites[l].password,!0,g_sites[l],g_shares)==lpmdec_acct(b.password,
!0,b,g_shares)&&("undefined"!=typeof g_tlds[g_sites[l].tld]&&"undefined"!=typeof g_tlds[g_sites[l].tld][l]&&delete g_tlds[g_sites[l].tld][l],delete g_sites[l]);if((d=d.getElementsByTagName("field"))&&0<d.length){b.fields=[];for(l=0;l<d.length;l++){g=d[l];k={};k.name=g.getAttribute("name");k.type=g.getAttribute("type");k.value=g.getAttribute("value");if(is_encrypted_field(k.type))k.value=crypto_atob(k.value);else if("checkbox"==k.type||"radio"==k.type)if(k.checked=!1,g=k.value.match(/-([0-1])$/))"1"==
g[1]&&(k.checked=!0),k.value=k.value.substring(0,k.value.length-2);k.formname="";b.fields[l]=k}a++}}if("undefined"==typeof b.attacharraychanges||f&&""!=f)f&&""!=f&&"undefined"!=typeof b.attacharraychanges&&rollbackattacharrayadds(b.attacharraychanges);else{if("undefined"!=typeof b.attacharraychanges.add)for(l in b.attacharraychanges.add)b.attacharraychanges.add.hasOwnProperty(l)&&(b.attachpresent="1",f=b.attacharraychanges.add[l],h&&(f.parent=b.aid,f.id=b.aid+"-"+f.id),f.size=newattach[f.id].size,
f.storagekey=newattach[f.id].key);applyattacharraychanges(b.attacharraychanges);b.attacharraychanges={}}l=e[0].getAttribute("accts_version");g_local_accts_version+=a;compare_accounts_versions(l,g_local_accts_version)?rewritelocalfile():get_accts();if("undefined"!=typeof b.retrieveattach&&1==b.retrieveattach){var n=function(){console.log("lpSaveSiteResponse : attachversion="+attachversion+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var a="version="+LP.en(lp_local_attach_version)+
"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",a,lpSaveAttach)};null==lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(a){(lp_local_attach_version=a)||(lp_local_attach_version=0);n()}):n();b.retrieveattach=null}refresh_windows();c.successCallback&&(b.sn?g_securenotes[b.aid]=b:is_application(b)?g_applications[b.appaid]=b:(g_sites[b.aid]=b,Topics.get(Topics.SITE_ADDED).publish(b)),c.successCallback(b));do_experimental_popupfill&&
(setTimeout(function(){recheckpage()},50),!LPContentScriptFeatures.new_save_site&&"undefined"!==typeof g_show_save_success_msg&&g_show_save_success_msg&&(doPopupSaveOK(g_popup_tabid_save),g_popup_tabid_save=null))}}}
function lpUpdateFieldsResponse(a,b,c){c.aid=c.acct.aid;c.newvalues=c.acct.newvalues;c.handler=lpUpdateFieldsResponse;if(!rsa_shareeautopushesresponse(a,c)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){b=c.acct;a=a.responseXML.documentElement;var d=a.getElementsByTagName("error");if(0<d.length&&(d=d[0].getAttribute("notloggedin"))&&"1"==d){loggedOut(!1,"lpUpdateFieldsResponse");return}a=a.getElementsByTagName("ok");if(0<a.length){d=a[0].getAttribute("accts_version");
if(compare_accounts_versions(d,g_local_accts_version)){a=a[0].getAttribute("urid");var d="0"==b.urid,e=!d;d&&(b.urid=a);if(b.fields)for(var f=0;f<b.fields.length;f++)d&&!b.fields[f].otherfield&&"1"!=b.fields[f].otherlogin?b.fields[f].urid=a:e&&!b.fields[f].otherfield&&"1"==b.fields[f].otherlogin&&"0"==b.fields[f].urid&&(b.fields[f].urid=a)}else get_accts();refresh_windows();c.successCallback&&c.successCallback(c.acct)}else c.errorCallback&&c.errorCallback()}}
function addNever(a){g_neverurls.neveraccounts.push(a);g_local_accts_version++;rewritelocalfile();a="url="+en(url2hex(a));lpMakeRequest(base_url+"add_never.php",a,null,null)}
function deleteGroup(a,b,c,d,e,f,h){d="undefined"==typeof f?null:f;h=h||!1;issharedfolder(g_shares,a);f="";for(var g in g_sites)g_sites[g].group==a&&(f+=(""==f?"":",")+g);for(g in g_securenotes)g_securenotes[g].group==a&&(f+=(""==f?"":",")+g);for(g in g_applications)g_applications[g].group==a&&(f+=(""==f?"":",")+"app"+g);if(""==f&&!e)return deleteGroup("\\"+a,b,c,"deleteGroup",1,d);if(""==f&&1==e){if(null==d){console_log("server.js : Failed to find group and groupid is null");return}e=null;f="";for(g in g_sites)if(g_sites[g].id==
d){e=g_sites[g].group;break}if(null==e)for(g in g_securenotes)if(g_securenotes[g].id==d){e=g_securenotes[g].group;break}if(null==e)for(g in g_applications)if(g_applications[g].id==d){e=g_applications[g].group;break}if(null!=e){for(g in g_sites)g_sites[g].group==a&&(f+=(""==f?"":",")+g);for(g in g_securenotes)g_securenotes[g].group==a&&(f+=(""==f?"":",")+g);for(g in g_applications)g_applications[g].group==a&&(f+=(""==f?"":",")+"app"+g)}""==f&&(f=d,console_log("server.js : Still couldn't find stuff -- just using the passed groupid : aids="+
f))}return deleteAid(f,b,!1,h,c,a)}function checkmultiplefolders(a){for(var b=!1,c=null,d=!0,e=0;e<a.length;e++){var f=get_record(a[e]);if(f)if(f=issharedfolder(g_shares,f.group))if(b){d=!1;break}else if(null==c)c=f.decsharename;else{if(c!=f.decsharename){d=!1;break}}else if(null!=c){d=!1;break}else b=!0}d||alertfrombg(gs("Sorry, you cannot perform this operation on a mix of shared and non-shared folders, or multiple shared folders at once."));return d}
function deleteAid(a,b,c,d,e,f,h,g){if(h&&!frame_and_topdoc_has_same_domain(g)&&(f=get_record(a),h="",f&&((h=f.useusername)||f.unencryptedUsername,h||f.sitename,h||f.name),ftd_report_error(g,"deleteaid"),!lpConfirmYesNo(gs("Are you sure you would like to delete this site from your LastPass vault?")+"\n\n"+h)))return!1;var k=a.split(",");if(!checkmultiplefolders(k))return!1;f="";for(h=g=0;h<k.length;h++){var l=k[h];if(is_application(l)){if(!check_ident_appaid(l))continue}else if(!check_ident_aid(l))continue;
var n,q;is_application(l)?(n=get_record(l),q=!1):(n=g_sites[l],q=g_prompts.edit_site_prompt,n||(q=g_prompts.edit_sn_prompt,n=g_securenotes[l]));if(n){f+=(""==f?"":",")+l;if("undefined"!=typeof n.sharefolderid&&(g=n.sharefolderid,l=issharedfolder(g_shares,n.group),!checkreadonly(l)))return!1;if(!c&&(n.pwprotect||q))return security_prompt(function(){deleteAid(a,b,!0,d,e)}),!1}}if(""==f)return!1;c=gs("Are you sure you would like to delete this site?");n.genpw?c=gs("Are you sure you would like to delete this generated password?"):
n.sn?c=gs("Are you sure you would like to delete this secure note?"):is_application(n)&&(c=gs("Are you sure you would like to delete this application?"));n.name&&n.name.length&&(c+=" ("+n.name+")");1<k.length&&(c=gs("Are you sure you would like to delete the selected items?"));n.group&&"http://group"==n.url&&(c=gs("Are you sure you would like to delete this group?")+" ("+n.group+")");if(!d)if(null==b){if(!g_isopera&&!confirm(c))return!1}else if(!g_isopera&&!b.confirm(c))return!1;k=f.split(",");c=
"";for(h=0;h<k.length;h++)if(l=k[h],is_application(l))delete g_applications[get_appaid(l)];else{if(!n.sn&&"http://group"!=n.url)try{delete g_tlds[n.tld][l],8==(g_loglogins&8)&&(c+=(""==c?"":",")+getusernamefromacct(g_sites[l]))}catch(r){}delete g_sites[l];delete g_securenotes[l]}g_local_accts_version++;rewritelocalfile();n="ajax=1&extjs=1&delete=1&aid="+en(f);n+=get_identity_param();0!=g&&(n+="&sharedfolderid="+en(g));""!=c&&(n+="&un="+en(AES.url2hex(c)));lpMakeRequest(base_url+"show.php",n,lpDeleteResponse);
e&&e();return!0}function lpDeleteResponse(a){a&&4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("result"),0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows()))}
function editAid(a,b,c,d){if(check_ident_aid(a))if(VaultToggle.useVault4_0()&&!d)g_sites[a]?LPPlatform.openTabDialog("site",{vaultItem:a}):is_application(a)?LPPlatform.openTabDialog("application",{vaultItem:0===a.indexOf("app")?a.substring(3):a}):LPPlatform.openTabDialog("note",{vaultItem:a});else{var e,f;is_application(a)?(e=get_record(a),f=!1):(e=g_sites[a],f=g_prompts.edit_site_prompt,e||(f=g_prompts.edit_sn_prompt,e=g_securenotes[a]));if(e)if(c||!e.pwprotect&&!f){g_site_data=[];for(var h in e)g_site_data[h]=
e[h];g_site_data.openchpw="1"==d&&"1"==g_site_data.pwch?1:0;var g=0;c=!1;if("undefined"!=typeof e.attachpresent&&"1"==e.attachpresent){g_site_data.attaches=[];for(h in lp_attaches)lp_attaches[h].parent==a&&g++;for(h in lp_attaches)lp_attaches[h].parent==a&&(0==lp_attaches[h].mimetype.indexOf("data:image")?(c=!0,function(a){lpReadAttach(lp_attaches[a].id,function(b){g_site_data.attaches[g_site_data.attaches.length]={id:lp_attaches[a].id,mimetype:lp_attaches[a].mimetype,filename:lp_attaches[a].filename,
bytes:b};g_site_data.attaches.length==g&&openURL(getchromeurl("site.html"))})}(h)):(g_site_data.attaches[g_site_data.attaches.length]={id:lp_attaches[h].id,mimetype:lp_attaches[h].mimetype,filename:lp_attaches[h].filename,bytes:null},c&&g_site_data.attaches.length==g&&openURL(getchromeurl("site.html"))))}c||openURL(getchromeurl("site.html"))}else e.pwprotect?security_prompt(function(){editAid(a,b,!0,d)},null,null,!0,a):security_prompt(function(){editAid(a,b,!0,d)})}}
function saveFields(a,b,c,d,e){if(c&&c.newvalues&&void 0===c.newvalues.length){var f=[],h;for(h in c.newvalues)f.push(c.newvalues[h]);c.newvalues=f}c=c||{};c.successCallback=d;c.errorCallback=e;c.url=base_url+"fields.php?"+a;c.postdata=b;lpMakeRequest(c.url,b,lpSaveFieldsResponse,e,c)}
function lpSaveFieldsResponse(a,b,c){c.handler=lpSaveFieldsResponse;if(!rsa_shareeautopushesresponse(a,c)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;b=a.getElementsByTagName("response");0<b.length&&(b=b[0].getAttribute("message"),console_log("server.js : Save Fields failed: "+b));b=a.getElementsByTagName("error");if(0<b.length&&(b=b[0].getAttribute("notloggedin"))&&"1"==b){loggedOut(!1,"lpSaveFieldsResponse");return}a=a.getElementsByTagName("result");
0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows(),c&&c.successCallback&&c.successCallback())}}var g_lastpoll=null;
function poll_server_request(){if(!(null!=g_lastpoll&&g_lastpoll>(new Date).getTime()-2)&&(g_lastpoll=(new Date).getTime(),lploggedin&&null==grid_getdata("active"))){var a=pollserver_url+"poll_server.php",b="";lpsendmpstrength&&null!=lpmpstrength&&(b+="&mpstrength="+LP.en(lpmpstrength));if(1==g_prompts.improve)for(var c in g_events)g_events.hasOwnProperty(c)&&(b+="&"+LP.en(c)+"="+LP.en(g_events[c]));g_events=[];lpMakeRequest(a,b,poll_server_response,null);g_lastpoll=(new Date).getTime()}}
function poll_server(){if(!g_nopoll){if(lploggedin&&null==grid_getdata("active")){var a=(new Date).getTime(),b=lpGetPref("logOffAfterLoggedInVal",0);if(0<b&&a-lastlogin>60*b){lplogoff(!1,"logoffafterloggedin");setTimeout(function(){poll_server()},6E4);return}g_lastpollcheck=a;1==lpGetPref("logoffWhenCloseBrowser",0)&&0<lpGetPref("logoffWhenCloseBrowserVal",0)&&(lpPutUserPref("lastpollcheck",g_lastpollcheck),lpWriteAllPrefs());var c=60*parseInt(lpGetPref("pollServerVal",15)),d=1E3*c,e=function(b){if("locked"==
b||"idle"==b)d*=g_logoff_other_ses?12:60;a-g_lastpoll>=d&&poll_server_request()};0<d&&(b=function(a){a?call_binary_function("get_idle_ms",function(a){e(a>=d?"idle":"active")}):enable_native_idle&&"undefined"!=typeof chrome&&"undefined"!=typeof chrome.idle?chrome.idle.queryState(c,e):e("active")},have_binary_function("get_idle_ms")?can_check_idle(b):b(!1))}setTimeout(function(){poll_server()},6E4)}}var g_notifications=[];
function handlenotifications(a,b,c){try{if(lplog("notify: title="+a+" text="+b+" url="+c),"undefined"!=typeof webkitNotifications&&webkitNotifications)if(0!=webkitNotifications.checkPermission())lplog("notify: requesting permission"),webkitNotifications.requestPermission(function(){lplog("notify: requesting permission callback called")});else{var d=webkitNotifications.createNotification("images/icon48.png",a,b);if(d){var e=(new Date).getTime()+"_"+Math.floor(100*Math.random());d.ondisplay=function(){lplog("notify: displaying notification id="+
e)};d.onclose=function(){lplog("notify: closing notification id="+e)};d.onclick=function(){lplog("notify: user clicked notification id="+e);c&&""!=c&&(lplog("notify: opening notication url for id="+e+" url="+c),d.cancel(),openURL(c))};d.show();g_notifications.push({id:e,time:(new Date).getTime(),note:d});1==g_notifications.length&&setTimeout(function(){notifications_autoclose()},0)}else lplog("notify: error : failed to create notification")}else g_isfirefoxsdk?g_ff_notifications.notify({title:a,text:b,
iconURL:self.data.url("images/icon48.png"),onClick:function(a){a&&""!=a&&openURL(a)},data:c}):lplog("notify: error: webkitNotifications is null")}catch(f){}}function notifications_autoclose(){}function notifications_closeall(){lplog("notify: closing all notifications");for(var a=0;a<g_notifications.length;++a)lplog("notify: closing notification id="+g_notifications[a].id),g_notifications[a].note.cancel();g_notifications=[]}
function poll_server_response(a){if(4==a.readyState)if(200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){if(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length){g_logoff_other_ses="1"==a[0].getAttribute("logoff_other_ses")?!0:!1;var b=a[0].getAttribute("accts_version");a[0].getAttribute("newbreach");var c=a[0].getAttribute("newalert");a[0].getAttribute("newbreach_msg");"true"==c&&handle_new_alerts(a[0]);g_server_accts_version=b;b>g_local_accts_version&&get_accts();
var d=a[0].getAttribute("attachversion"),e=function(){if(d>lp_local_attach_version){console.log("poll_server_response : attachversion="+d+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var a="version="+LP.en(lp_local_attach_version)+"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",a,lpSaveAttach)}};null==lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(a){(lp_local_attach_version=a)||(lp_local_attach_version=
0);e()}):e();lpsendmpstrength=null!=a[0].getAttribute("sendmpstrength")?!0:!1;(b=a[0].getAttribute("note_title"))&&b.length&&(c=a[0].getAttribute("note_text"),a=a[0].hasAttribute("note_url")?a[0].getAttribute("note_url"):null,handlenotifications(b,c,a))}}else lpReportError("Problem in poll_server_response. status="+a.status,null)}
function upgrade_response(a){if(4==a.readyState)if(200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement)if(a=a.responseXML.documentElement.getElementsByTagName("updatecheck"),0<a.length?(upgrade="1"==a[0].getAttribute("upgrade")?!0:!1,upgradeurl=a[0].getAttribute("codebase")):(upgrade=!1,upgradeurl=""),g_ischrome)g_notification_type="upgrade",g_notification_data={upgrade:upgrade,upgradeurl:upgradeurl},sendTS({cmd:"notification",type:"upgrade"});else{if(g_issafari||g_isopera||g_ismaxthon||
g_isfirefoxsdk)upgrade?confirm(gs("An Update is Available. Would you like to install?"))&&openURL(upgradeurl):alertfrombg(gs("No Updates Are Available"))}else lpReportError("Problem in upgrade_response. status="+a.status,null)}
function changePassword(a,b,c,d,e){debug&&console_log("changePassword called");var f=[];f.push(a);for(var h=[],g=0,k=0;k<b.length;k++)g_sites[b[k]]?(lpmdec_acct(g_sites[b[k]].password,!0,g_sites[b[k]],g_shares)!=a&&(h[h.length]=b[k]),"undefined"!=typeof g_sites[b[k]].sharefolderid&&(g=g_sites[b[k]].sharefolderid)):debug&&console_error("skipping bad aid in changePassword "+b[k]);b=h;if(0!=b.length){g_pending_pw_change={};for(var h="xml=1",l=[],n="",k=0;k<b.length;k++){var q=0<k?k:"",h=h+("&username"+
q+"=dummy"),h=h+("&password"+q+"="+LP.en(lpenc_acct(a,g_sites[b[k]],g_shares))),h=h+("&id"+q+"="+LP.en(b[k]));8==(g_loglogins&8)&&(n+=(""==n?"":",")+getusernamefromacct(g_sites[b[k]]));f.push(a);g_pending_pw_change[b[k]]=lpenc_acct(a,g_sites[b[k]],g_shares);try{lp_in_array(g_sites[b[k]].tld,l)||(l[l.length]=g_sites[b[k]].tld)}catch(r){}}try{for(k in g_sites)if(g_sites[k].genpw&&lp_in_array(g_sites[k].tld,l)&&lpmdec_acct(g_sites[k].password,!0,g_sites[k],g_shares)==a){h+="&delgenpwaid="+LP.en(k);break}}catch(r){}0!=
g&&(h+="&sharedfolderid="+en(g));""!=n&&(h+="&un="+en(AES.url2hex(n)));"undefined"!=typeof c&&c&&(h+="&autochange=1");a={aid:0,postdata:h,url:base_url+"change_pw.php",newvalues:f,successCallback:d,errorCallback:e};lpMakeRequest(a.url,h,lpChangePasswordResponse,e,a)}}
function lpChangePasswordResponse(a,b,c){c.handler=lpChangePasswordResponse;if(!rsa_shareeautopushesresponse(a,c)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement)if(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length){debug&&(b=(new Date).getTime(),console_log("received ok response from Password Change at "+b));b=crypto_atob(a[0].getAttribute("newpassword"));for(var d=[],e="";a[0].hasAttribute("oldpassword"+e);){var f=a[0].getAttribute("id"+e),h=crypto_atob(a[0].getAttribute("oldpassword"+
e)),f=g_sites[f];lp_in_array(f.tld,d)||(d[d.length]=f.tld);debug&&L("acct.password="+f.password+" oldpassword="+h+" newpassword="+b);if(f.password==h||lpmdec_acct(f.password,!0,f,g_shares)==lpmdec_acct(h,!0,f,g_shares))f.password=b;if(f.fields)for(var g=0;g<f.fields.length;g++)"password"!=f.fields[g].type||f.fields[g].value!=h&&lpmdec_acct(f.fields[g].value,!0,f,g_shares)!=lpmdec_acct(h,!0,f,g_shares)||(f.fields[g].value=b);delete g_pending_pw_change[f.aid];f.last_pwchange_gmt=parseInt((new Date).getTime()/
1E3);""==e?e=1:e++}for(g in g_sites)g_sites[g].genpw&&lp_in_array(g_sites[g].tld,d)&&lpmdec_acct(g_sites[g].password,!0,g_sites[g],g_shares)==lpmdec(b,!0)&&(verbose_log(sprintf("CHG: deleting generated password entry id=%s for password=%s",g,g_show_pw_in_logs||g_isadmin?lpmdec(b,!0):"REDACTED")),"undefined"!=typeof g_tlds[g_sites[g].tld]&&"undefined"!=typeof g_tlds[g_sites[g].tld][g]&&delete g_tlds[g_sites[g].tld][g],delete g_sites[g]);g_local_accts_version++;rewritelocalfile();c.successCallback&&
c.successCallback();c=a[0].getAttribute("accts_version");compare_accounts_versions(c,g_local_accts_version)||get_accts()}else c.errorCallback&&c.errorCallback()}var lpyubidata={};
function yubikey_getotp(a,b){grid_setdata("active","1");lpdbg("yubikey","Asking user for fresh otp");var c=b&&b.getAttribute("trustexpired")?b.getAttribute("trustexpired"):0,d=b&&b.getAttribute("trustlabel")?b.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&yubikey=1&trustexpired="+encodeURIComponent(c)+"&trustlabel="+encodeURIComponent(d)));return""}function yubikey_setdata(a,b){lpyubidata[a]=b}
function yubikey_getdata(a){return"undefined"==typeof lpyubidata[a]?null:lpyubidata[a]}function yubikey_cleardata(){lpdbg("yubikey","clearing data");lpyubidata={}}
function yubikey_auth(a,b){grid_setdata("active",null);if(""!=a)if("1"==yubikey_getdata("offline")){var c=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+c)+c));yubikey_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();yubikey_setdata("offline","0")}else{var d,e,f;yubikey_getdata("postdata")?(c=yubikey_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(c=sesame_getdata("logincheckpostdata")+
"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=b&&(c+="&trustlabel="+encodeURIComponent(b));var h=yubikey_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,c,e,f,h)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"yubikey_auth_error")}var lpgoogleauthdata={};
function googleauth_getotp(a,b){grid_setdata("active","1");lpdbg("googleauth","Asking user for fresh otp");var c=b&&b.getAttribute("trustexpired")?b.getAttribute("trustexpired"):0,d=b&&b.getAttribute("trustlabel")?b.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&googleauth=1&trustexpired="+encodeURIComponent(c)+"&trustlabel="+encodeURIComponent(d)));return""}function googleauth_setdata(a,b){lpgoogleauthdata[a]=b}
function googleauth_getdata(a){return"undefined"==typeof lpgoogleauthdata[a]?null:lpgoogleauthdata[a]}function googleauth_cleardata(){lpdbg("googleauth","clearing data");lpgoogleauthdata={}}
function googleauth_auth(a,b){grid_setdata("active",null);if(""!=a)if("1"==googleauth_getdata("offline")){var c=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+c)+c));googleauth_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();googleauth_setdata("offline","0")}else{var d,e,f;googleauth_getdata("postdata")?(c=googleauth_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(c=sesame_getdata("logincheckpostdata")+
"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=b&&(c+="&trustlabel="+encodeURIComponent(b));var h=googleauth_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,c,e,f,h)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"googleauth_auth_error")}var lpoutofbanddata={};
function outofband_getotp(a,b){grid_setdata("active","1");lpdbg("outofband","Asking user for fresh otp");var c=b&&b.getAttribute("trustexpired")?b.getAttribute("trustexpired"):0,d=b&&b.getAttribute("trustlabel")?b.getAttribute("trustlabel"):"";g_trustlabel="";"1"==b.getAttribute("preferduowebsdk")?(lpTurnOffIcon(),openbaseurl("duo.php?canexpire=1&cansetuuid=1&username="+encodeURIComponent(g_username)+"&trustexpired="+encodeURIComponent(c)+"&trustlabel="+encodeURIComponent(d))):openURL(getchromeurl("lp_toolstrip.html?browseraction=1&outofband=1&trustexpired="+
encodeURIComponent(b.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(b.getAttribute("trustlabel"))+"&capabilities="+encodeURIComponent(b.getAttribute("capabilities"))+"&allowtrust="+encodeURIComponent(b.getAttribute("allowtrust"))+"&smshash="+encodeURIComponent(b.getAttribute("smshash"))+"&smstime="+encodeURIComponent(b.getAttribute("smstime"))+"&smsuid="+encodeURIComponent(b.getAttribute("smsuid"))+"&outofbandimage="+encodeURIComponent(AES.bin2hex(b.getAttribute("outofbandimage")))+
"&sms_nextcode="+encodeURIComponent(b.getAttribute("sms_nextcode"))+"&textoverride="+encodeURIComponent(b.getAttribute("textoverride"))));return""}function outofband_setdata(a,b){lpoutofbanddata[a]=b}function outofband_getdata(a){return"undefined"==typeof lpoutofbanddata[a]?null:lpoutofbanddata[a]}function outofband_cleardata(){lpdbg("outofband","clearing data");lpoutofbanddata={}}var g_last_otpcheck,g_otpcheck_complete=!1,g_otpwin_closed=!1,g_trustlabel="";
function outofband_handler(a,b,c){g_otpwin_closed||(a&&4==a.readyState&&200==a.status&&0<a.responseText.indexOf("outofbandrequired")?null!=a.responseXML&&null!=a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("error"),0<a.length&&(a=a[0].getAttribute("retryid"))&&""!=a&&5E3<=(new Date).getTime()-g_last_otpcheck&&(postdata=outofband_getdata("postdata")+"&outofbandrequest=1&outofbandretry=1&outofbandretryid="+encodeURIComponent(a),g_last_otpcheck=(new Date).getTime(),
lpMakeRequest(base_url+"login.php",postdata,outofband_handler,b,c))):(g_otpcheck_complete=!0,closecurrenttab("lp_toolstrip.html?browseraction=1&outofband=1"),lpLoginResponse(a,b,c),""!=g_trustlabel&&null!=a.responseXML&&null!=a.responseXML.documentElement&&0<a.responseXML.documentElement.getElementsByTagName("ok").length&&getuuid(function(a){lpMakeRequest(base_url+"trust.php","canexpire=1&cansetuuid=1&uuid="+encodeURIComponent(a)+"&trustlabel="+encodeURIComponent(g_trustlabel),function(a){a&&4==a.readyState&&
200==a.status&&a.responseXML&&a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("ok"))&&0<a.length&&a[0].hasAttribute("trustuuid")&&(a=a[0].getAttribute("trustuuid"))&&""!=a&&setuuid(a,g_username_hash)});g_trustlabel=""},g_username_hash)))}
function outofband_auth(a,b){grid_setdata("active",null);if(""!=a)if(g_otpcheck_complete="dummy"!=a,g_otpwin_closed="dummy"!=a,"1"==outofband_getdata("offline")){var c=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+c)+c));outofband_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();outofband_setdata("offline","0")}else{var d,e;outofband_getdata("postdata")?(c=outofband_getdata("postdata"),d="login.php",e=lpLoginError):(c=sesame_getdata("logincheckpostdata"),
d="login_check.php",e=lpLoginCheckError);"dummy"!=a&&(c+="&otp="+encodeURIComponent(a));""!=b&&(c+="&trustlabel="+encodeURIComponent(b));var c=c+"&outofbandrequest=1",f=outofband_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");g_last_otpcheck=(new Date).getTime();lpMakeRequest(base_url+d,c,"dummy"==a?outofband_handler:lpLoginResponse,e,f)}else g_otpcheck_complete||(g_otpwin_closed=!0,lpshowError("LoginError",!1,!0),loggedOut(!1,"outofband_auth_error"))}
var lpsecurityquestiondata={};
function securityquestion_getotp(a,b){if(b.getAttribute("redirecturl"))openURL(b.getAttribute("redirecturl"));else return grid_setdata("active","1"),lpdbg("securityquestion","Asking user for fresh otp"),getuuid(function(a){openURL(getchromeurl("lp_toolstrip.html?browseraction=1&securityquestion=1&trustexpired="+encodeURIComponent(b.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(b.getAttribute("trustlabel"))+"&uuid="+encodeURIComponent(a)+"&question="+encodeURIComponent(b.getAttribute("question"))+
"&autotrust="+encodeURIComponent(b.getAttribute("autotrust"))+"&hidedisable="+encodeURIComponent(b.getAttribute("hidedisable"))+"&reseturl="+encodeURIComponent(b.getAttribute("reseturl"))));securityquestion_setdata("reseturl",b.getAttribute("reseturl"))},g_username_hash),""}function securityquestion_setdata(a,b){lpsecurityquestiondata[a]=b}function securityquestion_getdata(a){return"undefined"==typeof lpsecurityquestiondata[a]?null:lpsecurityquestiondata[a]}
function securityquestion_cleardata(){lpdbg("securityquestion","clearing data");lpsecurityquestiondata={}}
function securityquestion_auth(a,b){grid_setdata("active",null);if(""!=a)if("1"==securityquestion_getdata("offline")){var c=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+c)+c));securityquestion_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();securityquestion_setdata("offline","0")}else{var d,e,f;securityquestion_getdata("postdata")?(c=securityquestion_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=
lpLoginError):(c=sesame_getdata("logincheckpostdata")+"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=b&&(c+="&trustlabel="+encodeURIComponent(b));var h=securityquestion_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,c,e,f,h)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"securityquestion_auth_error")}var lpsesamedata={},lpsesameotp=null;
function sesame_setotp(a){lpdbg("sesame","browser forwarded OTP => sesame_setotp called");lpsesameotp=a}
function sesame_getotp(a,b){grid_setdata("active","1");if(a&&lpsesameotp){lpdbg("sesame","Not requesting OTP - using value passed to browser");var c=lpsesameotp;lpsesameotp=null;sesame_auth(c,"");return c}lpdbg("sesame","Asking user for fresh otp");var c=b&&b.getAttribute("trustexpired")?b.getAttribute("trustexpired"):0,d=b&&b.getAttribute("trustlabel")?b.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&sesame=1&trustexpired="+encodeURIComponent(c)+"&trustlabel="+
encodeURIComponent(d)));return""}function sesame_setdata(a,b){lpsesamedata[a]=b}function sesame_getdata(a){return"undefined"==typeof lpsesamedata[a]?null:lpsesamedata[a]}function sesame_cleardata(){lpdbg("sesame","clearing data");lpsesamedata={}}
function sesame_auth(a,b){grid_setdata("active",null);if(""!=a)if("1"==sesame_getdata("offline"))sesame_setdata("password_offline",a),offlineloginsuccessful("offline",0),lpReadAcctsData(),sesame_setdata("offline","0");else{var c,d,e,f;sesame_getdata("postdata")?(c=sesame_getdata("postdata")+"&sesameotp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(c=sesame_getdata("logincheckpostdata")+"&sesameotp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);
""!=b&&(c+="&trustlabel="+encodeURIComponent(b));var h=sesame_getdata("fromwebsite");console_log("server.js : Requesting "+d+" D");lpMakeRequest(base_url+d,c,e,f,h)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"sesame_auth_error")}var lpgriddata={},lpgridvalues=null;
function grid_getvalues(a,b,c){grid_setdata("active","1");openURL(getchromeurl("lp_toolstrip.html?browseraction=1&grid=1&trustexpired="+encodeURIComponent(c.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(c.getAttribute("trustlabel"))+"&challenge="+encodeURIComponent(b)))}function grid_setdata(a,b){lpgriddata[a]=b}function grid_getdata(a){return"undefined"==typeof lpgriddata[a]?null:lpgriddata[a]}function grid_cleardata(){lpdbg("grid","clearing data");lpgriddata={}}
function grid_auth(a,b){grid_setdata("active",null);if(""!=a){var c,d,e,f;grid_getdata("postdata")?(c=grid_getdata("postdata")+"&gridresponse="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(c=sesame_getdata("logincheckpostdata")+"&gridresponse="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=b&&(c+="&trustlabel="+encodeURIComponent(b));grid_getdata("wxsessid")&&(c+="&wxsessid="+encodeURIComponent(grid_getdata("wxsessid")));var h=
grid_getdata("fromwebsite");console_log("server.js : Requesting "+d+" E");lpMakeRequest(base_url+d,c,e,f,h)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"grid_auth_error")}var lpmultifactordata={},lpmultifactorresponse=null;
function multifactor_getresponse(a,b){var c="";multifactor_setdata("active","1");var d=multifactor_getdata("type"),e="";multifactor_getdata("type")==d&&(e=multifactor_getdata("password_offline"));e&&64==e.length||(e=SHA256(SHA256(fix_username(a)+d)));var f=function(){multifactor_setdata("password_offline",e);multifactor_setdata("type",d);if(b){if("omnikey"==d){omnikey_get_pin(function(a){have_binary_function("omnikey_decrypt")?call_binary_function("omnikey_decrypt",b,a,function(a){c=a;multifactor_auth(c,
"")}):multifactor_auth(c,"")});return}c=""!=e?SHA256(e+b):""}else c=e;multifactor_auth(c,"")};e&&64==e.length||"trueapi"!=d||!have_binary_function("trueapi_get_hash")?f():call_binary_function("trueapi_get_hash",a,function(a){e=a;f()})}function multifactor_setdata(a,b){lpmultifactordata[a]=b}function multifactor_getdata(a){return"undefined"==typeof lpmultifactordata[a]?null:lpmultifactordata[a]}function multifactor_cleardata(){lpdbg("multifactor","clearing data");lpmultifactordata={}}
function multifactor_auth(a,b){multifactor_setdata("active",null);if(""!=a)if("1"==multifactor_getdata("offline"))multifactor_setdata("password_offline",a),"omnikey"!=multifactor_getdata("type")&&multifactor_setdata("type","trueapi"),offlineloginsuccessful("offline",0),lpReadAcctsData(),multifactor_setdata("offline","0");else{var c,d,e,f;multifactor_getdata("postdata")?(c=multifactor_getdata("postdata")+"&multifactorresponse="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):
(c=sesame_getdata("logincheckpostdata")+"&multifactorresponse="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=b&&(c+="&trustlabel="+encodeURIComponent(b));multifactor_getdata("wxsessid")&&(c+="&wxsessid="+encodeURIComponent(multifactor_getdata("wxsessid")));multifactor_getdata("type")&&(c+="&type="+encodeURIComponent(multifactor_getdata("type")));var h=multifactor_getdata("fromwebsite");console_log("server.js : Requesting "+d+" F");lpMakeRequest(base_url+
d,c,e,f,h)}else lpshowError("LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,multifactor_getdata("type"))),loggedOut(!1,"multifactor_auth_error")}function multifactor_response(a,b){lpdbg("multifactor","in multifactor_response");"undefined"!=typeof a.callback?(lpdbg("multifactor","calling callback"),a.callback(b)):sendCS(a.tabid,b,a.docnum)}
function lpSetupMultifactorResponse(a,b,c){lpdbg("multifactor","setupmultifactorresponse: "+a.readyState);if(4==a.readyState){lpdbg("multifactor","setupmultifactorresponse: "+a.status);if(200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length)){var d=a[0].getAttribute("type");lpdbg("multifactor","setupmultifactorresponse: "+d);var e=a[0].getAttribute("hash");if("trueapi"==d)if("undefined"!=typeof c.password){if(have_binary_function("trueapi_store_default_login")){call_binary_function("trueapi_store_hash",
g_username,e,function(a){if(a){var b=function(a){a==e?call_binary_function("trueapi_store_default_login",g_username,c.password,e,function(a){a?(setsinglefactortype(d),"1"!=c.silent&&multifactor_response(c,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(c)}):lpSetupMultifactorError(c)};"1"==c.silent?b(e):call_binary_function("trueapi_get_hash",g_username,function(a){b(a)})}else lpSetupMultifactorError(c)});return}}else{if("1"!=c.silent&&have_binary_function("trueapi_store_hash")){call_binary_function("trueapi_store_hash",
g_username,e,function(a){a?call_binary_function("trueapi_get_hash",g_username,function(a){a==e?multifactor_response(c,{cmd:"setupmultifactor",result:"done"}):lpSetupMultifactorError(c)}):lpSetupMultifactorError(c)});return}}else if("vtapi"==d){if(have_binary_function("lpvt_store_data")){call_binary_function("lpvt_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(c.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),gs("Swipe current user's finger"),
function(a){a?(setsinglefactortype(d),"1"!=c.silent&&multifactor_response(c,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(c)});return}}else if("validity"==d){if(have_binary_function("validity_store_data")){call_binary_function("validity_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(c.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(a){a?(setsinglefactortype(d),"1"!=c.silent&&multifactor_response(c,{cmd:"setupsinglefactor",
result:"done"})):lpSetupMultifactorError(c)});return}}else if("winbio"==d){if(have_binary_function("winbio_store_data")){call_binary_function("winbio_has_fingerprints",function(a){lpdbg("multifactor","winbio_has_fingerprints: "+a);a?call_binary_function("winbio_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(c.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(a){lpdbg("multifactor","winbio_store_data: "+a);a?(setsinglefactortype(d),
"1"!=c.silent&&(lpdbg("multifactor","calling multifactor_response"),multifactor_response(c,{cmd:"setupsinglefactor",result:"done"}))):lpSetupMultifactorError(c)}):(have_binary_function("winbio_launch_enrollment")&&call_binary_function("winbio_launch_enrollment"),"1"!=c.silent&&multifactor_response(c,{cmd:"setupsinglefactor",result:"notenrolled"}))});return}}else{if("nymi"==d){have_binary_function("nymi_provision")&&call_binary_function("nymi_provision",encodeURIComponent(g_username)+"|"+encodeURIComponent(c.password),
function(a){lpdbg("multifactor","nymi_provision: "+a);a?(setsinglefactortype(d),"1"!=c.silent&&(lpdbg("multifactor","calling multifactor_response"),call_binary_function("nymi_read_data",function(a){multifactor_response(c,{cmd:"setupsinglefactor",result:"done_"+a})}))):lpSetupMultifactorError(c)});return}if("omnikey"==d){multifactor_response(c,{cmd:"setupsinglefactor",result:"done"});return}}}lpSetupMultifactorError(c)}}
function lpSetupMultifactorError(a){1!=a.silent&&multifactor_response(a,{cmd:"undefined"!=typeof a.password?"setupsinglefactor":"setupmultifactor",result:"error"})}function get_multifactor_disable_url(a,b){return"multifactordisable.php?cmd=sendemail&username="+en(a)+"&type="+en(b)}function lp_StartLogin(a,b){console_log("server.js : lp_StartLogin fromlogincheckack="+a);g_loginstarted||(g_loginstarted=!0,a?(rsa_setpendingsharests(),lplogincheck("frompipes",b)):httptest())}
function can_chrome_do_math(){return"cf80cd8aed482d5d1527d7dc72fceff84e6326592848447d2dc0b0e87dfc9a90"!=SHA256("testing")?!1:!0}
function lpDownloadDataResponse(a,b,c){if(a&&200==a.status&&4==a.readyState){b="";a=a.responseText.split("\n");for(var d=0;d<a.length;d++)if(0==a[d].indexOf("ff_")){var e=a[d].indexOf("=");if(-1!=e){var f=a[d].substr(0,e),e=a[d].substr(e+1),e=CheckStringForObfuscation(f,"",e);b+=f+"="+e+"\n"}}else b+=a[d]+"\n";localStorage_setItem(c,b);"ff.dat"==c?ApplyAllOverrides():"sites.dat"==c?LoadSpecialSites():"bigicon.dat"==c&&LoadBigIconList()}}
function checkIterationsInDataFile(a){var b=get_key_iterations(g_username),c=a.substring(0,20);return 0==c.indexOf("iterations=")?(c=/iterations=(\d*);/.exec(c),1<c.length&&b==c[1]?a.substring(a.indexOf(";")+1):"iterationserror"):1!=b?"iterationserror":a}function prependIterations(a){var b=get_key_iterations(g_username);1<b&&(a="iterations="+b+";"+a);return a}
function checkIterationsReductionOk(a){var b=SHA256(g_username)+"_key_iter";return"undefined"!=typeof localStorage&&null!=localStorage_getItem(b)&&localStorage_getItem(b)>a&&g_checkiterationsreduction?confirm(gs("IterationsReduction")):!0}function pref_numeric_validate(a,b){var c=parseInt(a);return 0>c||isNaN(c)?b:c}
function sendLpImprove(a,b){if((!g_username||g_prompts.improve)&&a){var c=get_method?get_method():"",c=(new PostParams).add("cmd","lpimprove").add("event",a).add("method",c);if(b)for(var d in b)b.hasOwnProperty(d)&&c.add(d,b[d]);lpMakeRequest(base_url+"lastpass/api.php",c.toString(),null,null)}}function isDogfood(){var a=!1;g_ischrome&&chrome.runtime.getManifest()&&-1<chrome.runtime.getManifest().short_name.toLowerCase().indexOf("dog")&&(a=!0);return a};
